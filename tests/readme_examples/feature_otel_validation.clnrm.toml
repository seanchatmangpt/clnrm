# README Example Test: OTEL Validation
# Verifies: "Telemetry-Only Validation (OTEL) - Prove system correctness using OpenTelemetry spans"
# Location in README: Lines 235-294

[test.metadata]
name = "verify_otel_validation"
description = "Verify OTEL validation with span validators as documented in README"
version = "1.0.0"

[otel]
exporter = "otlp"
endpoint = "http://localhost:4318"
protocol = "http/protobuf"
sample_ratio = 1.0
resources = { "service.name" = "clnrm", "env" = "test" }

[service.clnrm]
plugin = "generic_container"
image = "rust:1.70"
working_dir = "/workspace"
env = { "OTEL_EXPORTER_OTLP_ENDPOINT" = "http://localhost:4318" }

[[scenario]]
name = "otel_span_validation"
service = "clnrm"
run = "clnrm self-test --otel-exporter otlp --otel-endpoint http://localhost:4318"
artifacts.collect = ["spans:default"]

# Span validators from README (lines 255-265)
[[expect.span]]
name = "clnrm.run"
kind = "internal"
duration_ms = { min = 10, max = 60000 }

[[expect.span]]
name = "clnrm.step"
parent = "clnrm.run"
kind = "internal"

# Graph validation from README (lines 267-269)
[expect.graph]
must_include = [["clnrm.run", "clnrm.step"]]
acyclic = true

# Status validation from README
[expect.status]
all = "OK"

# Hermeticity validation from README (lines 270-272)
[expect.hermeticity]
no_external_services = true
resource_attrs.must_match = { "service.name" = "clnrm" }

[report]
json = "otel_validation_report.json"
digest = "otel_trace.sha256"
