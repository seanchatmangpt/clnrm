# README Metric Test: Hot Reload Approximately 3s
# Verifies: "Hot reload latency: Approximately 3s average"
# Location in README: Line 544

[test.metadata]
name = "verify_hot_reload_3s_average"
description = "Verify hot reload latency is approximately 3s average"
version = "1.0.0"

[service.hot_reload_metric]
plugin = "generic_container"
image = "rust:1.70"
working_dir = "/workspace"

[[scenario]]
name = "measure_hot_reload_average"
service = "hot_reload_metric"
run = """
# Measure hot reload latency over 5 iterations
TOTAL=0
ITERATIONS=5

for i in $(seq 1 $ITERATIONS); do
  # Modify test file
  echo '[test.metadata]
name = "test_'$i'"
description = "iteration '$i'"' > /tmp/hot_reload_test.clnrm.toml

  # Measure reload time
  START=$(date +%s%N)
  clnrm validate /tmp/hot_reload_test.clnrm.toml
  END=$(date +%s%N)
  ELAPSED=$(( (END - START) / 1000000 ))
  TOTAL=$(( TOTAL + ELAPSED ))

  echo "Iteration $i: ${ELAPSED}ms"
done

AVERAGE=$(( TOTAL / ITERATIONS ))
echo "Average hot reload latency: ${AVERAGE}ms (target: ~3000ms)"

# Verify reasonable performance (allow up to 5s for slower systems)
test ${AVERAGE} -lt 5000
"""

[[expect.output]]
pattern = "Average hot reload latency: [0-9]+ms"
description = "Should report average latency"

[[expect.output]]
pattern = "Iteration [0-9]+: [0-9]+ms"
description = "Should report individual iterations"

[[expect.status]]
exit_code = 0

[report]
json = "hot_reload_latency_metrics.json"
comment = "Performance target: Approximately 3s average, allowing up to 5s for test reliability"
