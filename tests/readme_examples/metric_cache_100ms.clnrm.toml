# README Metric Test: Cache operations under 100ms
# Verifies: "Cache operations: Typically under 100ms"
# Location in README: Line 546

[test.metadata]
name = "verify_cache_operations_100ms"
description = "Verify cache operations complete in under 100ms"
version = "1.0.0"

[service.cache_metric]
plugin = "generic_container"
image = "rust:1.70"
working_dir = "/workspace"

[[scenario]]
name = "measure_cache_operations"
service = "cache_metric"
run = """
# Create test file
cat > /tmp/cache_test.clnrm.toml << 'EOF'
[test.metadata]
name = "cache_test"
description = "Test caching"

[service.test]
plugin = "generic_container"
image = "alpine:latest"

[[scenario]]
name = "cached_scenario"
service = "test"
run = "echo Cached test"
EOF

# First run - populates cache
clnrm run /tmp/cache_test.clnrm.toml > /dev/null 2>&1

# Measure cached run (should be fast)
START=$(date +%s%N)
clnrm run /tmp/cache_test.clnrm.toml --use-cache
END=$(date +%s%N)
ELAPSED=$(( (END - START) / 1000000 ))

echo "Cache operation time: ${ELAPSED}ms"

# Allow generous margin for test reliability (10x target)
test ${ELAPSED} -lt 1000
"""

[[expect.output]]
pattern = "Cache operation time: [0-9]+ms"
description = "Should report cache operation time"

[[expect.status]]
exit_code = 0

[report]
json = "cache_operation_metrics.json"
comment = "Performance target: Typically under 100ms (allowing 1000ms for test reliability)"
