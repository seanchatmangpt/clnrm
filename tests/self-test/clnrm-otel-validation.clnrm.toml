# clnrm Self-Testing via OTEL Spans
# This test validates that clnrm itself works correctly by examining the OTEL spans it emits.
# Meta-testing: clnrm validating itself through its own telemetry.

[test.metadata]
name = "clnrm_otel_self_validation"
description = "Validate clnrm functionality by analyzing OTEL spans emitted during test execution"

# OTEL Collector service - captures spans from clnrm
[services.otel_collector]
type = "otel_collector"
plugin = "otel_collector"
image = "otel/opentelemetry-collector:latest"

[services.otel_collector.env]
ENABLE_OTLP_HTTP = "true"
ENABLE_OTLP_GRPC = "true"
ENABLE_PROMETHEUS = "false"
ENABLE_ZPAGES = "false"

# clnrm container - the system under test
[services.clnrm_test]
type = "generic_container"
plugin = "generic_container"
image = "clnrm:test"

[services.clnrm_test.env]
OTEL_SERVICE_NAME = "clnrm-under-test"
OTEL_EXPORTER_OTLP_ENDPOINT = "http://otel_collector:4318"
OTEL_EXPORTER_OTLP_PROTOCOL = "http/protobuf"
OTEL_TRACES_EXPORTER = "otlp"
RUST_LOG = "info"

# Test Steps
[[steps]]
name = "verify_collector_ready"
command = ["echo", "OTEL Collector started"]
expected_output_regex = "started"

[[steps]]
name = "run_clnrm_test"
service = "clnrm_test"
command = ["clnrm", "--version"]
expected_output_regex = "clnrm"

# OTEL Validation Section - Validate spans prove clnrm works
[otel_validation]
enabled = true
validate_spans = true
validate_traces = true

# Expected Spans - These prove clnrm's core functionality

[[otel_validation.expected_spans]]
name = "clnrm.run"
required = true

[[otel_validation.expected_spans]]
name = "clnrm.test"
required = true

[otel_validation.expected_spans.attributes]
"test.hermetic" = "true"

[[otel_validation.expected_spans]]
name = "clnrm.service.start"
required = true

[[otel_validation.expected_spans]]
name = "clnrm.command.execute"
required = true

# Expected Trace - Validate span hierarchy
[[otel_validation.expected_traces]]
span_names = ["clnrm.run", "clnrm.test", "clnrm.service.start", "clnrm.command.execute"]
complete = true

[[otel_validation.expected_traces.parent_child]]
parent = "clnrm.run"
child = "clnrm.test"

[[otel_validation.expected_traces.parent_child]]
parent = "clnrm.test"
child = "clnrm.service.start"
