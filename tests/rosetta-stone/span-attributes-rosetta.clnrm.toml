# Rosetta Stone Test #6: Span Attributes Validation
# Validates: ATTRIBUTE dimension - comprehensive attribute validation
# Pattern: Required attributes, value validation, semantic conventions
#
# This test ensures:
# - Required attributes are present
# - Attribute values match expected patterns
# - Semantic conventions are followed (OpenTelemetry standards)
# - Service metadata is correct
# - Custom attributes are properly set

[test.metadata]
name = "rosetta_span_attributes"
description = "Validates span attributes, values, and semantic conventions"
timeout = "90s"

# OTEL Collector
[services.otel_collector]
type = "otel_collector"
plugin = "otel_collector"
image = "otel/opentelemetry-collector:latest"

[services.otel_collector.env]
ENABLE_OTLP_HTTP = "true"

# HTTP Server - produces spans with HTTP semantic conventions
[services.http_server]
type = "generic_container"
image = "alpine:latest"

[services.http_server.env]
OTEL_SERVICE_NAME = "rosetta-http-server"
OTEL_SERVICE_VERSION = "1.2.3"
DEPLOYMENT_ENVIRONMENT = "testing"
OTEL_EXPORTER_OTLP_ENDPOINT = "http://otel_collector:4318"

# Database Client - produces spans with DB semantic conventions
[services.db_client]
type = "generic_container"
image = "postgres:16-alpine"

[services.db_client.env]
POSTGRES_PASSWORD = "testpass"
OTEL_SERVICE_NAME = "rosetta-db-client"
OTEL_SERVICE_VERSION = "2.0.1"
DEPLOYMENT_ENVIRONMENT = "testing"
OTEL_EXPORTER_OTLP_ENDPOINT = "http://otel_collector:4318"

# Messaging Service - produces spans with messaging semantic conventions
[services.messaging_service]
type = "generic_container"
image = "alpine:latest"

[services.messaging_service.env]
OTEL_SERVICE_NAME = "rosetta-messaging"
OTEL_SERVICE_VERSION = "0.9.0"
DEPLOYMENT_ENVIRONMENT = "testing"
OTEL_EXPORTER_OTLP_ENDPOINT = "http://otel_collector:4318"

# Test Steps - Generate spans with rich attributes
[[steps]]
name = "http_get_request"
service = "http_server"
command = ["echo", "HTTP GET /api/users"]

[[steps]]
name = "http_post_request"
service = "http_server"
command = ["echo", "HTTP POST /api/users"]

[[steps]]
name = "db_select_query"
service = "db_client"
command = ["sh", "-c", "echo 'SELECT * FROM users WHERE id = 1'"]

[[steps]]
name = "db_insert_query"
service = "db_client"
command = ["sh", "-c", "echo 'INSERT INTO users VALUES (2, john)'"]

[[steps]]
name = "message_publish"
service = "messaging_service"
command = ["echo", "Publishing message to queue"]

[[steps]]
name = "message_consume"
service = "messaging_service"
command = ["echo", "Consuming message from queue"]

# OTEL Validation - Attribute dimension
[otel_validation]
enabled = true
validate_spans = true
validate_attributes = true

# HTTP Server spans - HTTP semantic conventions
[[otel_validation.expected_spans]]
name = "http.server.request"
required = true
count = 2

[otel_validation.expected_spans.attributes]
"http.method" = "GET"
"http.target" = "/api/users"
"http.status_code" = "200"
"http.scheme" = "http"
"http.flavor" = "1.1"
"service.name" = "rosetta-http-server"
"service.version" = "1.2.3"
"deployment.environment" = "testing"

[otel_validation.expected_spans.required_attributes]
attributes = ["http.method", "http.target", "http.status_code", "service.name"]

[[otel_validation.expected_spans]]
name = "http.server.request"
required = true

[otel_validation.expected_spans.attributes]
"http.method" = "POST"
"http.target" = "/api/users"
"http.status_code" = "201"
"http.request.body.size" = "256"

# Database spans - DB semantic conventions
[[otel_validation.expected_spans]]
name = "db.query"
required = true

[otel_validation.expected_spans.attributes]
"db.system" = "postgresql"
"db.operation" = "SELECT"
"db.statement" = "SELECT * FROM users WHERE id = ?"
"db.name" = "testdb"
"db.user" = "postgres"
"service.name" = "rosetta-db-client"
"service.version" = "2.0.1"

[otel_validation.expected_spans.required_attributes]
attributes = ["db.system", "db.operation", "db.statement"]

[[otel_validation.expected_spans]]
name = "db.query"
required = true

[otel_validation.expected_spans.attributes]
"db.system" = "postgresql"
"db.operation" = "INSERT"
"db.table" = "users"

# Messaging spans - Messaging semantic conventions
[[otel_validation.expected_spans]]
name = "messaging.publish"
required = true

[otel_validation.expected_spans.attributes]
"messaging.system" = "rabbitmq"
"messaging.destination" = "user.events"
"messaging.operation" = "publish"
"messaging.message.id" = { pattern = "^[a-f0-9-]{36}$" }
"service.name" = "rosetta-messaging"
"service.version" = "0.9.0"

[otel_validation.expected_spans.required_attributes]
attributes = ["messaging.system", "messaging.destination", "messaging.operation"]

[[otel_validation.expected_spans]]
name = "messaging.consume"
required = true

[otel_validation.expected_spans.attributes]
"messaging.system" = "rabbitmq"
"messaging.destination" = "user.events"
"messaging.operation" = "consume"

# Attribute validation rules
[[otel_validation.attribute_constraints]]
attribute_name = "http.status_code"
data_type = "integer"
valid_range = [200, 599]

[[otel_validation.attribute_constraints]]
attribute_name = "service.version"
data_type = "string"
pattern = "^\\d+\\.\\d+\\.\\d+$"  # Semantic versioning

[[otel_validation.attribute_constraints]]
attribute_name = "deployment.environment"
data_type = "string"
allowed_values = ["development", "testing", "staging", "production"]

[[otel_validation.attribute_constraints]]
attribute_name = "messaging.message.id"
data_type = "string"
pattern = "^[a-f0-9-]{36}$"  # UUID format

# Resource attributes validation
[[otel_validation.resource_attributes]]
required = true

[otel_validation.resource_attributes.attributes]
"service.name" = { required = true }
"service.version" = { required = true }
"deployment.environment" = { required = true }

[assertions]
all_required_attributes_present = true
attribute_values_valid = true
semantic_conventions_followed = true
execution_should_be_hermetic = true
