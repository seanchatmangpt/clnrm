# Rosetta Stone Test #3: Cardinality Validation
# Validates: CARDINALITY dimension - exact span counts and per-service validation
# Pattern: Execute N operations, validate exactly N spans
#
# This test ensures:
# - Span counts match operation counts exactly
# - No duplicate spans
# - No missing spans
# - Per-service span accounting is accurate

[test.metadata]
name = "rosetta_cardinality_validation"
description = "Validates exact span counts and per-service cardinality constraints"
timeout = "90s"

# OTEL Collector
[services.otel_collector]
type = "otel_collector"
plugin = "otel_collector"
image = "otel/opentelemetry-collector:latest"

[services.otel_collector.env]
ENABLE_OTLP_HTTP = "true"

# Service A - performs exactly 5 operations
[services.service_a]
type = "generic_container"
image = "alpine:latest"

[services.service_a.env]
OTEL_SERVICE_NAME = "rosetta-service-a"
OTEL_EXPORTER_OTLP_ENDPOINT = "http://otel_collector:4318"

# Service B - performs exactly 3 operations
[services.service_b]
type = "generic_container"
image = "alpine:latest"

[services.service_b.env]
OTEL_SERVICE_NAME = "rosetta-service-b"
OTEL_EXPORTER_OTLP_ENDPOINT = "http://otel_collector:4318"

# Service C - performs exactly 7 operations
[services.service_c]
type = "generic_container"
image = "alpine:latest"

[services.service_c.env]
OTEL_SERVICE_NAME = "rosetta-service-c"
OTEL_EXPORTER_OTLP_ENDPOINT = "http://otel_collector:4318"

# Test Steps - Controlled operation counts
[[steps]]
name = "service_a_operation_1"
service = "service_a"
command = ["echo", "A-Op-1"]

[[steps]]
name = "service_a_operation_2"
service = "service_a"
command = ["echo", "A-Op-2"]

[[steps]]
name = "service_a_operation_3"
service = "service_a"
command = ["echo", "A-Op-3"]

[[steps]]
name = "service_a_operation_4"
service = "service_a"
command = ["echo", "A-Op-4"]

[[steps]]
name = "service_a_operation_5"
service = "service_a"
command = ["echo", "A-Op-5"]

[[steps]]
name = "service_b_operation_1"
service = "service_b"
command = ["echo", "B-Op-1"]

[[steps]]
name = "service_b_operation_2"
service = "service_b"
command = ["echo", "B-Op-2"]

[[steps]]
name = "service_b_operation_3"
service = "service_b"
command = ["echo", "B-Op-3"]

[[steps]]
name = "service_c_batch_operations"
service = "service_c"
command = ["sh", "-c", "for i in 1 2 3 4 5 6 7; do echo C-Op-$i; done"]

# OTEL Validation - Cardinality dimension
[otel_validation]
enabled = true
validate_spans = true
validate_cardinality = true

# Service A - expect exactly 5 spans
[[otel_validation.span_count_constraints]]
service_name = "rosetta-service-a"
span_name = "service.operation"
exact_count = 5
reason = "Service A performs exactly 5 operations"

# Service B - expect exactly 3 spans
[[otel_validation.span_count_constraints]]
service_name = "rosetta-service-b"
span_name = "service.operation"
exact_count = 3
reason = "Service B performs exactly 3 operations"

# Service C - expect exactly 7 spans
[[otel_validation.span_count_constraints]]
service_name = "rosetta-service-c"
span_name = "service.operation"
exact_count = 7
reason = "Service C performs exactly 7 operations in batch"

# Total span count validation
[[otel_validation.span_count_constraints]]
span_name = "service.operation"
exact_count = 15  # 5 + 3 + 7
reason = "Total operations across all services"

# No duplicate spans
[[otel_validation.span_count_constraints]]
span_name = "service.operation"
max_count = 15
reason = "No duplicate spans should exist"

# Per-service breakdown
[[otel_validation.expected_spans]]
name = "service.operation"
required = true
count = 5

[otel_validation.expected_spans.attributes]
"service.name" = "rosetta-service-a"

[[otel_validation.expected_spans]]
name = "service.operation"
required = true
count = 3

[otel_validation.expected_spans.attributes]
"service.name" = "rosetta-service-b"

[[otel_validation.expected_spans]]
name = "service.operation"
required = true
count = 7

[otel_validation.expected_spans.attributes]
"service.name" = "rosetta-service-c"

# Trace cardinality
[[otel_validation.expected_traces]]
trace_count = 3  # One per service
complete = true

[assertions]
total_span_count_should_equal = 15
execution_should_be_hermetic = true
no_duplicate_spans = true
