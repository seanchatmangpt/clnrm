# CLNRM v0.7.0 User Workflows

**Visual workflow diagrams for critical user journeys**

---

## Workflow 1: First-Time User Journey

### v0.6.0 Experience (Slow Feedback Loop)

```
┌─────────────────────────────────────────────────────────┐
│ FIRST-TIME USER JOURNEY (v0.6.0)                       │
└─────────────────────────────────────────────────────────┘

Step 1: Initialize
┌──────────────┐
│ clnrm init   │  Duration: ~2s
└──────┬───────┘
       │
       ↓
┌──────────────────────────────┐
│ Generated:                   │
│  - tests/basic.clnrm.toml   │
│  - README.md                 │
└──────────────────────────────┘

Step 2: Edit Test
┌──────────────────────────────┐
│ vim tests/basic.clnrm.toml  │
│ # Make changes, save         │
└──────┬───────────────────────┘
       │
       ↓

Step 3: Run Tests (SLOW ⏱️)
┌──────────────┐
│ clnrm run    │  Duration: 15-30s
└──────┬───────┘
       │
       ↓
┌──────────────────────────────┐
│ ❌ Test failed!              │
│ Error: Expected "hello"      │
│        Got: "Hello"          │
└──────┬───────────────────────┘
       │
       ↓

Step 4: Fix Error
┌──────────────────────────────┐
│ vim tests/basic.clnrm.toml  │
│ # Fix regex pattern          │
└──────┬───────────────────────┘
       │
       ↓

Step 5: Run Again (SLOW AGAIN ⏱️)
┌──────────────┐
│ clnrm run    │  Duration: 15-30s
└──────┬───────┘
       │
       ↓
┌──────────────────────────────┐
│ ✅ Test passed!              │
└──────────────────────────────┘

TOTAL TIME: ~60-90 seconds for one edit-fix cycle
MANUAL COMMANDS: 3 (init, run, run)
PAIN POINTS:
  - 15-30s wait per run
  - Manual command repetition
  - Context switching between editor and terminal
```

### v0.7.0 Experience (Instant Feedback)

```
┌─────────────────────────────────────────────────────────┐
│ FIRST-TIME USER JOURNEY (v0.7.0 with dev --watch)      │
└─────────────────────────────────────────────────────────┘

Step 1: Initialize
┌──────────────┐
│ clnrm init   │  Duration: ~2s
└──────┬───────┘
       │
       ↓
┌──────────────────────────────┐
│ Generated:                   │
│  - tests/basic.clnrm.toml   │
│  - README.md                 │
│  - ~/.clnrm/templates/       │
│    └── _macros.toml.tera     │
└──────────────────────────────┘

Step 2: Start Watch Mode (NEW! ✨)
┌──────────────────────┐
│ clnrm dev --watch    │
└──────┬───────────────┘
       │
       ↓
┌────────────────────────────────────────┐
│ 🔍 Watching for changes...             │
│ 📋 Found 1 test file                   │
│ 🚀 Running initial test...             │
│    ✅ basic_test (127ms)                │
│ ✨ All tests passed!                   │
│ 👀 Press Ctrl+C to stop watching       │
└────────────────────────────────────────┘
       │
       │ (Terminal stays open, watching)
       │
       ↓

Step 3: Edit Test (AUTOMATIC TRIGGER ⚡)
┌──────────────────────────────┐
│ vim tests/basic.clnrm.toml  │
│ # Change: "Hello" → "Goodbye"│
│ :wq                          │  <--- File saved
└──────┬───────────────────────┘
       │
       │ (Watch mode detects change automatically!)
       │
       ↓
┌────────────────────────────────────────┐
│ 📝 File changed: basic.clnrm.toml      │
│ 🚀 Running tests...                    │  Duration: <3s
│    ❌ basic_test (131ms)                │
│       Expected: "Goodbye"               │
│       Got: "Hello from cleanroom!"     │
│ 👀 Still watching...                    │
└────────────────────────────────────────┘
       │
       │ (No manual command needed!)
       │
       ↓

Step 4: Fix Error (AUTOMATIC TRIGGER ⚡)
┌──────────────────────────────┐
│ vim tests/basic.clnrm.toml  │
│ # Revert: "Goodbye" → "Hello"│
│ :wq                          │  <--- File saved
└──────┬───────────────────────┘
       │
       │ (Watch mode detects change automatically!)
       │
       ↓
┌────────────────────────────────────────┐
│ 📝 File changed: basic.clnrm.toml      │
│ 🚀 Running tests...                    │  Duration: <3s
│    ✅ basic_test (129ms)                │
│ ✨ All tests passed!                   │
│ 👀 Still watching...                    │
└────────────────────────────────────────┘

TOTAL TIME: ~15-20 seconds for one edit-fix cycle
MANUAL COMMANDS: 2 (init, dev --watch) - then ZERO!
PAIN POINTS ELIMINATED:
  ✅ Instant feedback (<3s instead of 15-30s)
  ✅ No manual command repetition
  ✅ Stay focused in editor
  ✅ See results immediately after save

IMPROVEMENT: 5-10x faster iteration!
```

---

## Workflow 2: Template Authoring with Macros

### v0.6.0 Experience (Massive Boilerplate)

```
┌─────────────────────────────────────────────────────────┐
│ TEMPLATE AUTHORING (v0.6.0 - Without Macros)           │
└─────────────────────────────────────────────────────────┘

TASK: Validate OpenTelemetry traces for 3 services

┌──────────────────────────────────────────────────┐
│ tests/microservices.clnrm.toml (150+ lines!)    │
└──────────────────────────────────────────────────┘

[meta]
name = "microservices-otel-validation"
version = "0.6.0"

[services.api]
plugin = "generic_container"
image = "nginx:alpine"

[services.postgres]
plugin = "generic_container"
image = "postgres:15"

[services.redis]
plugin = "generic_container"
image = "redis:7-alpine"

# API lifecycle (12 lines)
[[expect.span]]
name = "api.start"
kind = "internal"

[[expect.span]]
name = "api.exec"
kind = "internal"

[[expect.span]]
name = "api.stop"
kind = "internal"

[expect.order]
must_precede = [
  ["api.start", "api.exec"],
  ["api.exec", "api.stop"]
]

# Postgres lifecycle (12 lines)
[[expect.span]]
name = "postgres.start"
kind = "internal"

[[expect.span]]
name = "postgres.exec"
kind = "internal"

[[expect.span]]
name = "postgres.stop"
kind = "internal"

[expect.order]
must_precede = [
  ["postgres.start", "postgres.exec"],
  ["postgres.exec", "postgres.stop"]
]

# Redis lifecycle (12 lines)
[[expect.span]]
name = "redis.start"
kind = "internal"

[[expect.span]]
name = "redis.exec"
kind = "internal"

[[expect.span]]
name = "redis.stop"
kind = "internal"

[expect.order]
must_precede = [
  ["redis.start", "redis.exec"],
  ["redis.exec", "redis.stop"]
]

# Parent-child relationships (8 lines)
[expect.graph]
must_include = [
  ["test-root", "api.start"],
  ["api.exec", "postgres.exec"],
  ["api.exec", "redis.exec"]
]

# Time windows (6 lines)
[expect.window]
"api.exec" = { contains = ["postgres.exec"] }

[expect.window]
"api.exec" = { contains = ["redis.exec"] }

# Span counts (4 lines)
[expect.count]
by_kind.internal = { min = 9 }

[expect.count]
by_kind.client = { min = 2, max = 4 }

# HTTP request span (4 lines)
[[expect.span]]
name = "http.request"
kind = "server"
attrs.all = { "http.method" = "GET", "http.route" = "/api/users" }

[[steps]]
name = "execute_test"
command = ["sh", "-c", "echo 'Test complete'"]

TOTAL LINES: ~150 lines
TIME TO AUTHOR: 30-45 minutes
PAIN POINTS:
  - Massive repetition (3x lifecycle blocks)
  - Error-prone copy-paste
  - Hard to maintain (change 1 service → edit 12 lines)
  - Difficult to review
```

### v0.7.0 Experience (Concise Macros)

```
┌─────────────────────────────────────────────────────────┐
│ TEMPLATE AUTHORING (v0.7.0 - With Macro Pack)          │
└─────────────────────────────────────────────────────────┘

TASK: Validate OpenTelemetry traces for 3 services

┌──────────────────────────────────────────────────────┐
│ tests/microservices.clnrm.toml.tera (35 lines!)     │
└──────────────────────────────────────────────────────┘

{% import "_macros.toml.tera" as m %}

[meta]
name = "microservices-otel-validation"
version = "0.7.0"

[services.api]
plugin = "generic_container"
image = "nginx:alpine"

[services.postgres]
plugin = "generic_container"
image = "postgres:15"

[services.redis]
plugin = "generic_container"
image = "redis:7-alpine"

# Service lifecycles (3 lines instead of 36!)
{{ m::lifecycle("api") }}
{{ m::lifecycle("postgres") }}
{{ m::lifecycle("redis") }}

# Parent-child relationships (1 block instead of 8 lines)
{{ m::edges([
  ["test-root", "api.start"],
  ["api.exec", "postgres.exec"],
  ["api.exec", "redis.exec"]
]) }}

# Time windows (2 lines instead of 6)
{{ m::window("api.exec", "postgres.exec") }}
{{ m::window("api.exec", "redis.exec") }}

# Span counts (2 lines)
{{ m::count("internal", 9) }}
{{ m::count("client", 2, 4) }}

# HTTP request span (1 line instead of 4)
{{ m::span("http.request", "server", {"http.method": "GET", "http.route": "/api/users"}) }}

[[steps]]
name = "execute_test"
command = ["sh", "-c", "echo 'Test complete'"]

TOTAL LINES: ~35 lines (77% reduction!)
TIME TO AUTHOR: 5-10 minutes (5-6x faster!)
BENEFITS:
  ✅ 77% less code to write
  ✅ No repetitive copy-paste
  ✅ Change 1 service → edit 1 line
  ✅ Easy to review
  ✅ Clear intent (self-documenting)

IMPROVEMENT: 10x less boilerplate!
```

---

## Workflow 3: Pre-Flight Validation

### v0.6.0 Experience (Slow Error Detection)

```
┌─────────────────────────────────────────────────────────┐
│ VALIDATION WORKFLOW (v0.6.0 - Runtime Errors Only)     │
└─────────────────────────────────────────────────────────┘

Step 1: Edit Complex Test
┌──────────────────────────────────────┐
│ vim tests/complex.clnrm.toml        │
│ # Add 50 lines of OTEL validation   │
│ # Make 2 typos (line 42, line 67)   │
│ :wq                                  │
└──────┬───────────────────────────────┘
       │
       ↓

Step 2: Run Test (SLOW ⏱️)
┌──────────────────────┐
│ clnrm run tests/     │  Duration: 15-30s
└──────┬───────────────┘
       │
       │ (Containers spinning up...)
       │
       ↓
┌──────────────────────────────────────┐
│ ❌ Error parsing TOML!               │
│    Line 42: Unexpected token         │
│                                      │
│ (Only shows FIRST error)             │
└──────┬───────────────────────────────┘
       │
       ↓

Step 3: Fix First Error
┌──────────────────────────────────────┐
│ vim tests/complex.clnrm.toml        │
│ # Jump to line 42, fix typo          │
│ :wq                                  │
└──────┬───────────────────────────────┘
       │
       ↓

Step 4: Run Again (SLOW AGAIN ⏱️)
┌──────────────────────┐
│ clnrm run tests/     │  Duration: 15-30s
└──────┬───────────────┘
       │
       │ (Containers spinning up AGAIN...)
       │
       ↓
┌──────────────────────────────────────┐
│ ❌ Error parsing TOML!               │
│    Line 67: Missing service 'db'     │
│                                      │
│ (Now shows SECOND error)             │
└──────┬───────────────────────────────┘
       │
       ↓

Step 5: Fix Second Error
┌──────────────────────────────────────┐
│ vim tests/complex.clnrm.toml        │
│ # Jump to line 67, add service       │
│ :wq                                  │
└──────┬───────────────────────────────┘
       │
       ↓

Step 6: Run Again (SLOW AGAIN ⏱️)
┌──────────────────────┐
│ clnrm run tests/     │  Duration: 15-30s
└──────┬───────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ ✅ All tests passed!                 │
└──────────────────────────────────────┘

TOTAL TIME: 60-90 seconds (3 runs × 15-30s each)
ITERATIONS: 3 runs to catch 2 errors
PAIN POINTS:
  - 15-30s per error discovery
  - Only shows one error at a time
  - Containers spin up just to fail on parse errors
  - Serial error fixing (can't batch)
```

### v0.7.0 Experience (Instant Batch Validation)

```
┌─────────────────────────────────────────────────────────┐
│ VALIDATION WORKFLOW (v0.7.0 - Pre-Flight Validation)   │
└─────────────────────────────────────────────────────────┘

Step 1: Edit Complex Test
┌──────────────────────────────────────┐
│ vim tests/complex.clnrm.toml        │
│ # Add 50 lines of OTEL validation   │
│ # Make 2 typos (line 42, line 67)   │
│ :wq                                  │
└──────┬───────────────────────────────┘
       │
       ↓

Step 2: Dry-Run Validation (FAST ⚡)
┌────────────────────────────┐
│ clnrm dry-run tests/       │  Duration: <1s
└──────┬─────────────────────┘
       │
       │ (No containers! Pure TOML validation)
       │
       ↓
┌──────────────────────────────────────────────────────┐
│ ❌ Validation failed                                 │
│                                                      │
│ tests/complex.clnrm.toml:42:5                       │
│   error: Unexpected token ':'                        │
│                                                      │
│ tests/complex.clnrm.toml:67:12                      │
│   error: Service 'db' referenced but not defined     │
│                                                      │
│ 2 errors found in 1 file                            │
└──────┬───────────────────────────────────────────────┘
       │
       │ (Shows ALL errors at once!)
       │
       ↓

Step 3: Fix Both Errors (BATCH FIX!)
┌──────────────────────────────────────┐
│ vim tests/complex.clnrm.toml        │
│ # Jump to line 42, fix typo          │
│ # Jump to line 67, add service       │
│ :wq                                  │
└──────┬───────────────────────────────┘
       │
       ↓

Step 4: Verify Fixes (FAST ⚡)
┌────────────────────────────┐
│ clnrm dry-run tests/       │  Duration: <1s
└──────┬─────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ ✅ All validations passed            │
│    1 file validated                  │
│    No errors found                   │
└──────┬───────────────────────────────┘
       │
       │ (Now confident to run!)
       │
       ↓

Step 5: Run Tests (CONFIDENT!)
┌──────────────────────┐
│ clnrm run tests/     │  Duration: 15-30s
└──────┬───────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ ✅ All tests passed!                 │
└──────────────────────────────────────┘

TOTAL TIME: 20-35 seconds (<1s + <1s + 15-30s)
ITERATIONS: 2 validations (instant) + 1 run (success)
BENEFITS:
  ✅ <1s per validation (15-30x faster)
  ✅ Batch error reporting (see all errors at once)
  ✅ No wasted container spin-up
  ✅ Fix multiple errors before running

IMPROVEMENT: 15-30x faster error detection!
```

---

## Workflow 4: Combined Power (dev + macros + dry-run)

### The Ultimate v0.7.0 Experience

```
┌─────────────────────────────────────────────────────────┐
│ ULTIMATE DX WORKFLOW (v0.7.0 - All Features Combined)  │
└─────────────────────────────────────────────────────────┘

┌──────────────────────────────────┐
│ Terminal 1: Watch Mode           │
└──────────────────────────────────┘

$ clnrm dev --watch
🔍 Watching for changes...
✨ All tests passed!
👀 Press Ctrl+C to stop watching

┌──────────────────────────────────┐
│ Terminal 2: Authoring            │
└──────────────────────────────────┘

$ vim tests/api-trace.clnrm.toml.tera

{% import "_macros.toml.tera" as m %}

[meta]
name = "api_distributed_trace"
version = "0.7.0"

[services.api]
plugin = "generic_container"
image = "api:latest"

[services.db]
plugin = "generic_container"
image = "postgres:15"

# Generate lifecycle + graph in 4 lines!
{{ m::lifecycle("api") }}
{{ m::lifecycle("db") }}

{{ m::edges([["api.exec", "db.query"]]) }}
{{ m::window("api.exec", "db.query") }}

:wq  <--- Save file

┌──────────────────────────────────┐
│ Terminal 1: Auto-Rerun (INSTANT) │
└──────────────────────────────────┘

📝 File changed: api-trace.clnrm.toml.tera
🚀 Running tests...
   ✅ api_distributed_trace (234ms)
✨ All tests passed!
👀 Still watching...

┌──────────────────────────────────┐
│ Terminal 2: Add More Validation  │
└──────────────────────────────────┘

$ vim tests/api-trace.clnrm.toml.tera

# Oops, made a typo in service name
{{ m::lifecycle("apii") }}  # <--- typo!

:wq  <--- Save file

┌──────────────────────────────────┐
│ Terminal 1: Auto-Rerun (ERROR)   │
└──────────────────────────────────┘

📝 File changed: api-trace.clnrm.toml.tera
🚀 Running tests...
   ❌ Service 'apii' referenced but not defined
👀 Still watching...

┌──────────────────────────────────┐
│ Terminal 2: Fix Typo             │
└──────────────────────────────────┘

$ vim tests/api-trace.clnrm.toml.tera

# Fix typo
{{ m::lifecycle("api") }}  # <--- fixed!

:wq  <--- Save file

┌──────────────────────────────────┐
│ Terminal 1: Auto-Rerun (SUCCESS) │
└──────────────────────────────────┘

📝 File changed: api-trace.clnrm.toml.tera
🚀 Running tests...
   ✅ api_distributed_trace (241ms)
✨ All tests passed!
👀 Still watching...

┌──────────────────────────────────────────────────────────┐
│ DEVELOPER FLOW:                                          │
│   1. Edit template with macros (10x less code)           │
│   2. Save → auto-validation + auto-run (<3s)             │
│   3. Fix errors immediately (instant feedback)           │
│   4. Repeat until green                                  │
│                                                          │
│ ZERO MANUAL COMMANDS AFTER 'dev --watch'!                │
└──────────────────────────────────────────────────────────┘

PRODUCTIVITY MULTIPLIER: 8-10x improvement!
  ✅ 10x less code (macros)
  ✅ 5-10x faster iteration (watch)
  ✅ Instant validation (dry-run embedded in watch)
  ✅ Zero context switching
  ✅ Stay in flow state
```

---

## Summary: v0.6.0 vs v0.7.0

| Workflow | v0.6.0 | v0.7.0 MVP | Improvement |
|----------|--------|-----------|-------------|
| **First-time user** | 60-90s edit-fix cycle | 15-20s edit-fix cycle | **4-6x faster** |
| **Template authoring** | 150 lines, 30-45 min | 35 lines, 5-10 min | **10x less code, 5x faster** |
| **Error detection** | 60-90s (3 runs) | <2s (instant batch) | **30-45x faster** |
| **Manual commands** | 3+ per cycle | 2 total (then zero) | **~95% reduction** |
| **Context switching** | Editor ↔ terminal | Stay in editor | **Zero switching** |

**Overall Productivity**: **8-10x improvement** in daily workflows!

---

**These workflows demonstrate why the 80/20 prioritization (dev, macros, dry-run) delivers maximum user value.**
