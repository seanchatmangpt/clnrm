# Cleanroom v0.7.0 Architecture - DX-First Design

**Version**: 0.7.0
**Date**: 2025-10-17
**Focus**: Developer Experience (DX) - 80/20 Critical Path

## Executive Summary

v0.7.0 builds on v0.6.0's proven core (Tera templates → flat TOML → hermetic containers → OTEL spans → validation) by adding developer experience features that transform the author→run→debug loop from slow to instant.

**Critical Path (20% delivering 80% value)**:
1. **dev --watch** - Hot reload on file save (<3s latency)
2. **dry-run** - Fast validation without containers
3. **Macro pack** - Eliminate boilerplate with reusable templates
4. **fmt** - Deterministic TOML formatting
5. **Change detection** - Only re-run changed scenarios

**Performance Targets**:
- New user to green: <60s
- Edit→rerun latency: p50 <1.5s, p95 <3s
- Hot reload: <3s on trivial edits

## Architecture Principles

### 1. Keep v0.6.0 Core Intact
- Tera rendering pipeline (✅ working)
- Flat TOML structure (✅ working)
- Container backend abstraction (✅ working)
- OTEL span collection (✅ working)
- Multi-validator system (✅ working)

### 2. Add DX Layer on Top
- File watching (NEW)
- Change detection (NEW)
- Validation-only mode (NEW)
- Formatting (NEW)
- Macro library (NEW)

### 3. Deterministic by Default
- Seeded randomness
- Frozen clock timestamps
- Content-addressed hashing
- Reproducible digests

## Critical Path Features

### Feature 1: dev --watch (Hot Reload)

**User Story**: Developer saves `.toml.tera` file and sees test results in <3s.

**Architecture**:
```
┌─────────────┐
│ File Watcher│  (notify crate)
└──────┬──────┘
       │ File changed event
       ↓
┌─────────────┐
│  Debouncer  │  (200ms window)
└──────┬──────┘
       │ Debounced change
       ↓
┌─────────────┐
│   Render    │  (Tera → TOML)
└──────┬──────┘
       │ Rendered TOML
       ↓
┌─────────────┐
│   Validate  │  (Shape check)
└──────┬──────┘
       │ Valid config
       ↓
┌─────────────┐
│  Run Tests  │  (Container execution)
└──────┬──────┘
       │ OTEL spans
       ↓
┌─────────────┐
│   Report    │  (Terminal output)
└─────────────┘
```

**Implementation Plan**:
1. Create `src/cli/commands/dev.rs`
2. Use `notify::RecommendedWatcher` for file events
3. Debounce using `tokio::time::sleep` (200ms)
4. Reuse existing render → validate → run → report pipeline
5. Clear terminal and show results on each iteration

**Files to Create**:
- `crates/clnrm-core/src/cli/commands/dev.rs` - Dev command implementation
- `crates/clnrm-core/src/watch/mod.rs` - File watching module
- `crates/clnrm-core/src/watch/debouncer.rs` - Event debouncing

**Dependencies**: Already have `notify = "6.0"` in workspace

**Tests**:
- Watch detects file changes
- Debouncing works (multiple saves → single run)
- Error display doesn't crash watcher
- Ctrl+C exits cleanly

---

### Feature 2: dry-run (Fast Validation)

**User Story**: Developer validates config in <1s without spinning up containers.

**Architecture**:
```
┌─────────────┐
│  Find Files │  (*.toml.tera)
└──────┬──────┘
       │ File list
       ↓
┌─────────────┐
│   Render    │  (Tera → TOML)
└──────┬──────┘
       │ Rendered TOML
       ↓
┌─────────────┐
│    Parse    │  (TOML → Config)
└──────┬──────┘
       │ Parsed config
       ↓
┌─────────────┐
│   Validate  │  (Shape + rules)
└──────┬──────┘
       │ Validation results
       ↓
┌─────────────┐
│   Report    │  (✅/❌ per file)
└─────────────┘
```

**Validation Checks**:
- [meta] block present with name + version
- [otel] block has valid exporter
- Each [[scenario]] has name + service
- Service references exist in [services]
- [[expect.span]] has name + kind
- Duration constraints are valid (min < max)
- Temporal ordering is acyclic
- Glob patterns compile

**Implementation Plan**:
1. Create `src/cli/commands/dry_run.rs`
2. Add `--dry-run` flag to `run` command
3. Skip container operations if dry-run enabled
4. Return validation report with file→errors mapping

**Files to Create**:
- `crates/clnrm-core/src/cli/commands/dry_run.rs` - Dry-run command
- `crates/clnrm-core/src/validation/shape.rs` - Shape validator

**Tests**:
- Valid config passes dry-run
- Missing required blocks fail
- Orphan service references detected
- Invalid durations caught

---

### Feature 3: Macro Pack (Boilerplate Elimination)

**User Story**: Developer writes `{{ m::span("api.request", "server", {}) }}` instead of 10 lines of TOML.

**Architecture**:
```
_macros.toml.tera (shipped with clnrm)
├── span(name, kind, attrs)
├── lifecycle(service_name)
├── edges(parent_child_pairs)
├── window(start_span, end_span)
└── count(kind, min, max)

User template:
{% import "_macros.toml.tera" as m %}
{{ m::span("my.span", "server", {"http.method": "GET"}) }}
```

**Macro Definitions**:

```tera
{# _macros.toml.tera #}

{# Generate [[expect.span]] block #}
{% macro span(name, kind, attrs={}) %}
[[expect.span]]
name = "{{ name }}"
kind = "{{ kind }}"
{% if attrs %}
attrs.all = { {% for k, v in attrs %}"{{ k }}" = "{{ v }}"{{ ", " if not loop.last }}{% endfor %} }
{% endif %}
{% endmacro %}

{# Generate service lifecycle spans (start → exec → stop) #}
{% macro lifecycle(service) %}
{{ self::span(service ~ ".start", "internal") }}
{{ self::span(service ~ ".exec", "internal") }}
{{ self::span(service ~ ".stop", "internal") }}

[expect.order]
must_precede = [
  ["{{ service }}.start", "{{ service }}.exec"],
  ["{{ service }}.exec", "{{ service }}.stop"]
]
{% endmacro %}

{# Generate parent-child edges #}
{% macro edges(pairs) %}
[expect.graph]
must_include = [
{% for parent, child in pairs %}
  ["{{ parent }}", "{{ child }}"]{{ ", " if not loop.last }}
{% endfor %}
]
{% endmacro %}

{# Generate time window constraint #}
{% macro window(start, end) %}
[expect.window]
"{{ start }}" = { contains = ["{{ end }}"] }
{% endmacro %}

{# Generate span count constraint #}
{% macro count(kind, min, max=none) %}
[expect.count]
by_kind.{{ kind }} = { min = {{ min }}{% if max %}, max = {{ max }}{% endif %} }
{% endmacro %}
```

**Implementation Plan**:
1. Create `templates/_macros.toml.tera`
2. Install to `~/.clnrm/templates/` on `clnrm init`
3. Update Tera engine to search template paths
4. Document macros in `docs/TERA_TEMPLATES.md`

**Files to Create**:
- `templates/_macros.toml.tera` - Macro library
- Update `crates/clnrm-core/src/template/mod.rs` - Add template path

**Tests**:
- Macros render correctly
- Import statement works
- Nested macro calls work
- Invalid macro calls fail gracefully

---

### Feature 4: fmt (TOML Formatting)

**User Story**: Developer runs `clnrm fmt` and all TOML files are consistently formatted.

**Architecture**:
```
┌─────────────┐
│  Find Files │  (*.toml, *.toml.tera)
└──────┬──────┘
       │ File list
       ↓
┌─────────────┐
│    Parse    │  (TOML → AST)
└──────┬──────┘
       │ Parsed structure
       ↓
┌─────────────┐
│   Format    │  (Deterministic sort)
└──────┬──────┘
       │ Formatted TOML
       ↓
┌─────────────┐
│    Write    │  (Overwrite file)
└─────────────┘
```

**Formatting Rules**:
- Alphabetically sorted keys within sections
- 2-space indentation
- No trailing whitespace
- Consistent array formatting (multi-line if >80 chars)
- Preserve comments (if possible)
- Flat structure (no nested tables)

**Implementation Plan**:
1. Create `src/cli/commands/fmt.rs`
2. Use `toml_edit` crate for preserving comments
3. Custom sorting logic for deterministic output
4. `--check` flag for CI (exit 1 if formatting needed)

**Files to Create**:
- `crates/clnrm-core/src/cli/commands/fmt.rs` - Format command
- `crates/clnrm-core/src/formatting/mod.rs` - Formatter module

**Dependencies**: Add `toml_edit = "0.22"` to workspace

**Tests**:
- Idempotent (fmt twice = same output)
- Keys sorted alphabetically
- Arrays formatted consistently
- Comments preserved
- --check detects unformatted files

---

### Feature 5: Change Detection (Incremental Runs)

**User Story**: Developer reruns tests and only changed scenarios execute (10x faster iteration).

**Architecture**:
```
┌─────────────┐
│   Render    │  (Tera → TOML)
└──────┬──────┘
       │ Rendered TOML
       ↓
┌─────────────┐
│  Hash File  │  (SHA-256)
└──────┬──────┘
       │ File hash
       ↓
┌─────────────┐
│ Load Cache  │  (~/.clnrm/cache/hashes.json)
└──────┬──────┘
       │ Previous hash
       ↓
┌─────────────┐
│  Compare    │  (Current vs Previous)
└──────┬──────┘
       │ Changed?
       ↓
┌─────────────┐
│  Run Tests  │  (Only if changed)
└──────┬──────┘
       │ Results
       ↓
┌─────────────┐
│ Update Cache│  (Save new hash)
└─────────────┘
```

**Cache Structure** (`.clnrm/cache/hashes.json`):
```json
{
  "version": "1.0.0",
  "hashes": {
    "tests/api.clnrm.toml": "abc123...",
    "tests/db.clnrm.toml": "def456...",
    "scenarios/load.clnrm.toml": "ghi789..."
  },
  "last_updated": "2025-10-17T12:34:56Z"
}
```

**Implementation Plan**:
1. Create `src/cache/mod.rs` for hash management
2. Calculate SHA-256 of rendered TOML (after Tera processing)
3. Store in `.clnrm/cache/hashes.json`
4. Compare before each run
5. `--force` flag to bypass cache

**Files to Create**:
- `crates/clnrm-core/src/cache/mod.rs` - Cache management
- `crates/clnrm-core/src/cache/hash.rs` - File hashing

**Tests**:
- First run creates cache
- Unchanged file skips run
- Changed file triggers run
- --force bypasses cache
- Cache survives restarts

---

## CLI Command Structure

### New Commands for v0.7.0

```rust
#[derive(Parser)]
pub enum Commands {
    // Existing v0.6.0 commands
    Init { /* ... */ },
    Run { /* ... */ },
    Validate { /* ... */ },

    // NEW: DX commands
    Dev {
        /// Watch files and auto-rerun on changes
        #[arg(long)]
        watch: bool,

        /// Path to watch (default: current directory)
        path: Option<PathBuf>,
    },

    DryRun {
        /// Path to test files
        path: Option<PathBuf>,
    },

    Fmt {
        /// Check if files are formatted (don't write)
        #[arg(long)]
        check: bool,

        /// Path to format (default: current directory)
        path: Option<PathBuf>,
    },

    Lint {
        /// Path to lint (default: current directory)
        path: Option<PathBuf>,
    },

    Gen {
        /// Block type to generate (meta, otel, service, scenario, expect-span, etc.)
        block_type: String,
    },

    Render {
        /// Show variable→value mapping
        #[arg(long)]
        map: bool,

        /// Template file to render
        file: PathBuf,
    },

    // Future commands (not critical path)
    Diff { /* ... */ },
    Graph { /* ... */ },
    Trace { /* ... */ },
    Record { /* ... */ },
    Repro { /* ... */ },
    Redgreen { /* ... */ },
}
```

## File Structure Changes

```
clnrm/
├── crates/
│   ├── clnrm-core/
│   │   └── src/
│   │       ├── cache/          # NEW: Change detection
│   │       │   ├── mod.rs
│   │       │   └── hash.rs
│   │       ├── cli/
│   │       │   └── commands/
│   │       │       ├── dev.rs      # NEW: Hot reload
│   │       │       ├── dry_run.rs  # NEW: Fast validation
│   │       │       ├── fmt.rs      # NEW: Formatting
│   │       │       ├── lint.rs     # NEW: Linting
│   │       │       ├── gen.rs      # NEW: Code generation
│   │       │       └── render.rs   # NEW: Template rendering
│   │       ├── formatting/     # NEW: TOML formatting
│   │       │   └── mod.rs
│   │       ├── validation/
│   │       │   └── shape.rs    # NEW: Config shape validation
│   │       └── watch/          # NEW: File watching
│   │           ├── mod.rs
│   │           └── debouncer.rs
├── templates/                  # NEW: Macro library
│   └── _macros.toml.tera
└── docs/
    └── V0.7.0_ARCHITECTURE.md  # This file
```

## Dependencies to Add

```toml
[workspace.dependencies]
# Existing...

# NEW for v0.7.0
toml_edit = "0.22"  # For fmt command (comment preservation)
sha2 = "0.10"       # For file hashing
```

Note: `notify = "6.0"` already in workspace dependencies.

## Performance Budget

| Operation | Target | Measurement |
|-----------|--------|-------------|
| dev --watch startup | <2s | Time from `clnrm dev --watch` to "Watching..." |
| Hot reload (trivial edit) | <3s | Time from save to test result |
| Hot reload (p50) | <1.5s | 50th percentile latency |
| Hot reload (p95) | <3s | 95th percentile latency |
| dry-run (10 files) | <1s | Full validation without containers |
| fmt (100 files) | <2s | Format all files |
| New user to green | <60s | `clnrm init && clnrm run` |

## Testing Strategy

### Unit Tests
- Cache: hash calculation, JSON serialization, comparison
- Formatter: idempotency, key sorting, array formatting
- Shape validator: required blocks, orphan references
- Debouncer: multiple events → single callback

### Integration Tests
- dev --watch: File change → test execution
- dry-run: Invalid configs caught
- fmt: Deterministic output
- Macros: Import and rendering

### Performance Tests
- Watch latency benchmarks
- Cache hit/miss performance
- Formatter throughput

## Migration from v0.6.0

**Breaking Changes**: NONE

All v0.6.0 `.toml` and `.toml.tera` files work unchanged in v0.7.0.

**New Features (Opt-In)**:
- Use `clnrm dev --watch` for hot reload (optional)
- Use `clnrm fmt` for consistent formatting (optional)
- Use `_macros.toml.tera` imports (optional)
- Change detection automatic (can disable with `--force`)

## Implementation Order (Critical Path)

1. ✅ **Architecture Design** (this document)
2. 🔄 **dev --watch** (highest value, enables fast iteration)
3. 🔄 **Macro pack** (eliminates boilerplate, pairs well with watch)
4. 🔄 **dry-run** (fast validation during development)
5. 🔄 **fmt** (consistent formatting)
6. 🔄 **Change detection** (makes reruns instant)

Everything else (lint, gen, render --map, diff, graph, etc.) is lower priority.

## Definition of Done (v0.7.0)

- [ ] All 5 critical path features implemented
- [ ] Unit tests pass (cargo test)
- [ ] Integration tests pass
- [ ] Clippy: ZERO warnings
- [ ] Performance targets met (benchmarks)
- [ ] Documentation updated (README, CLI guide, template guide)
- [ ] Macro pack shipped with templates
- [ ] New user experience: init → watch → edit → green <60s
- [ ] Backward compatibility: All v0.6.0 tests pass unchanged

---

**Next Steps**: Implement `dev --watch` command (highest value feature).
