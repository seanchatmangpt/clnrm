# CLI Issues Analysis - Commands Not Working

## üîç **Issues Identified**

### 1. **File Extension Mismatch** ‚ùå
**Problem**: CLI expects `.clnrm.toml` files, but examples and init command use `.toml`

**Evidence**:
- CLI validation code: `ACCEPTED_EXTENSIONS: &[&str] = &[".clnrm.toml"]`
- Examples use: `simple-test.toml`, `first-test.toml`
- Init command creates: `basic.toml` (wrong)

**Impact**: 
- `clnrm validate examples/quickstart/first-test.toml` fails
- `clnrm run examples/quickstart/first-test.toml` fails
- All example files are unusable

### 2. **TOML Structure Mismatch** ‚ùå
**Problem**: CLI expects different TOML structure than what's generated/used

**Expected by CLI** (from `TestConfig` struct):
```toml
[test.metadata]
name = "test_name"
description = "test description"

[[services]]  # Array of services
name = "service_name"
type = "service_type"
plugin = "plugin_name"
image = "image_name"

[[steps]]
name = "step_name"
command = ["cmd", "args"]
expected_output_regex = "pattern"
```

**Generated by Init Command**:
```toml
[test.metadata]
name = "basic_test"
description = "Basic integration test"

[services.test_container]  # Table format (wrong)
type = "generic_container"
plugin = "alpine"
image = "alpine:latest"

[[steps]]
name = "hello_world"
command = ["echo", "Hello from cleanroom!"]
expected_output_regex = "Hello from cleanroom!"
```

**Used in Examples**:
```toml
[test.metadata]
name = "container_lifecycle_test"

[services.test_container]  # Table format (wrong)
type = "generic_container"
plugin = "alpine"
image = "alpine:latest"

[[steps]]
name = "verify_container_startup"
command = ["echo", "Container started successfully"]
expected_output_regex = "Container started successfully"
```

**Impact**:
- TOML parsing fails with "invalid type: map, expected a sequence"
- All test files are unparseable
- CLI cannot run any tests

### 3. **Init Command Issues** ‚ùå
**Problem**: Init command generates wrong TOML format and wrong file extension

**Current Init Behavior**:
- Creates `basic.toml` (should be `basic.clnrm.toml`)
- Uses `[services.test_container]` format (should be `[[services]]`)
- Generates incompatible TOML structure

**Impact**:
- Generated files cannot be validated or run
- Users get broken projects from `clnrm init`

### 4. **Template Command Issues** ‚ùå
**Problem**: Template command also generates wrong format

**Current Template Behavior**:
- Creates `basic.toml` (wrong extension)
- Uses completely different TOML structure
- Not compatible with CLI expectations

## üß™ **Test Results**

### ‚úÖ **Working Commands**
- `clnrm --version` ‚úÖ
- `clnrm --help` ‚úÖ
- `clnrm plugins` ‚úÖ
- `clnrm services status` ‚úÖ
- `clnrm report --help` ‚úÖ
- `clnrm self-test --help` ‚úÖ

### ‚ùå **Broken Commands**
- `clnrm init` ‚ùå (generates wrong format)
- `clnrm validate` ‚ùå (expects wrong file extension)
- `clnrm run` ‚ùå (cannot parse TOML files)

### üîç **Specific Error Messages**
```bash
# Validate command
Error: ConfigurationError: TOML parse error: TOML parse error at line 9, column 2
  |
9 | [services.test_container]
  |  ^^^^^^^^
invalid type: map, expected a sequence

# Run command  
Error: ConfigurationError: TOML parse error: TOML parse error at line 1, column 1
  |
1 | # Cleanroom Test Configuration
  | ^
missing field `test`
```

## üõ†Ô∏è **Required Fixes**

### 1. **Fix File Extension Handling**
- Update `ACCEPTED_EXTENSIONS` to include `.toml`
- Or update all examples to use `.clnrm.toml`
- Fix init command to create correct file extension

### 2. **Fix TOML Structure**
- Update `TestConfig` struct to handle `[services.service_name]` format
- Or update init command and examples to use `[[services]]` format
- Ensure consistency across all TOML files

### 3. **Fix Init Command**
- Generate correct file extension (`.clnrm.toml`)
- Generate compatible TOML structure
- Ensure generated files can be validated and run

### 4. **Fix Template Command**
- Generate correct file extension
- Generate compatible TOML structure
- Ensure consistency with CLI expectations

## üéØ **Root Cause**

The CLI was designed with one TOML structure, but the implementation (init command, examples) uses a different structure. This creates a fundamental incompatibility where:

1. **CLI expects**: `[[services]]` array format
2. **Examples use**: `[services.service_name]` table format
3. **Init generates**: `[services.service_name]` table format

## üìä **Impact Assessment**

- **High Impact**: Core functionality (run, validate, init) is broken
- **User Experience**: Users cannot use the CLI as documented
- **Examples**: All example files are unusable
- **Documentation**: README examples don't work

## üöÄ **Priority Fixes**

1. **Immediate**: Fix TOML structure compatibility
2. **High**: Fix init command to generate working files
3. **Medium**: Update file extension handling
4. **Low**: Update examples to match CLI expectations

This analysis shows that the CLI has fundamental structural issues that prevent core functionality from working.
