# CLNRM v0.7.0 DX Features - 80/20 Summary

**Date**: 2025-10-16
**Status**: READY FOR IMPLEMENTATION
**Timeline**: 2 weeks (10 business days)

---

## TL;DR

Implement **3 features** that deliver **90% of DX value** in **60% of planned effort**:

1. **dev --watch** → 5-10x faster iteration (instant feedback)
2. **Macro pack** → 10x less boilerplate (1 line vs 10 lines)
3. **dry-run** → 15-30x faster validation (1s vs 30s)

**Total Implementation**: 10 days | **Total Value**: 8-10x productivity boost

---

## Priority Matrix (80/20 Analysis)

| Feature | Value | Effort | Ratio | Priority | Timeline |
|---------|-------|--------|-------|----------|----------|
| **dev --watch** | 🔥 90% | 2-3 days | 45 | **MVP** | Days 1-3 |
| **Macro pack** | 🔥 80% | 1-2 days | 40-80 | **MVP** | Days 4-5 |
| **dry-run** | 🟡 60% | 1 day | 60 | **MVP** | Day 6 |
| fmt | 🟢 30% | 2-3 days | 10-15 | v0.7.1+ | Deferred |
| Change detection | 🟢 40% | 2 days | 20 | v0.7.1+ | Deferred |

---

## Critical User Workflows

### 1. First-Time User (CRITICAL)

**Before (v0.6.0):**
```bash
$ clnrm init                    # 2s
$ vim tests/basic.toml         # Edit
$ clnrm run                     # 15-30s
$ vim tests/basic.toml         # Fix error
$ clnrm run                     # 15-30s AGAIN
```
**Pain**: 15-30s feedback loop kills productivity.

**After (v0.7.0 with dev --watch):**
```bash
$ clnrm init                    # 2s
$ clnrm dev --watch            # Starts watching
$ vim tests/basic.toml         # Save → auto-rerun in <3s ✅
```
**Value**: **5-10x faster** iteration, instant feedback.

### 2. Template Authoring (HIGH VALUE)

**Before (v0.6.0):**
```toml
# 40 lines of repetitive TOML
[[expect.span]]
name = "api.request"
kind = "server"
attrs.all = { "service.name" = "api" }

[[expect.span]]
name = "api.response"
kind = "server"
attrs.all = { "service.name" = "api" }
# ... repeat 8 more times
```

**After (v0.7.0 with macros):**
```toml
{% import "_macros.toml.tera" as m %}

# 4 lines with macros!
{{ m::span("api.request", "server", {"service.name": "api"}) }}
{{ m::span("api.response", "server", {"service.name": "api"}) }}

# Or just 1 line!
{{ m::lifecycle("api") }}
```
**Value**: **10x less code**, 70% boilerplate elimination.

### 3. Validation (MEDIUM VALUE)

**Before (v0.6.0):**
```bash
$ clnrm run tests/api.toml  # 15-30s to find typo
Error: Invalid TOML line 42
```

**After (v0.7.0 with dry-run):**
```bash
$ clnrm dry-run tests/api.toml  # <1s validation
Error: Invalid TOML line 42
Error: Missing service at line 67
```
**Value**: **15-30x faster** error detection, batch fixes.

---

## Implementation Roadmap

### Week 1: Core DX Loop (Days 1-5)

**Days 1-3: dev --watch**
- Day 1: File watcher + debouncing
- Day 2: Error handling + terminal clearing
- Day 3: Integration tests + performance tuning
- **Deliverable**: `clnrm dev --watch` command working
- **Unlocks**: 50% of DX improvement

**Days 4-5: Macro pack**
- Day 4: 5 core macros + template path config
- Day 5: Integration tests + documentation
- **Deliverable**: `_macros.toml.tera` shipped with clnrm
- **Unlocks**: 30% of DX improvement

### Week 2: Validation + Polish (Days 6-10)

**Day 6: dry-run**
- Morning: Shape validator implementation
- Afternoon: CLI integration + error formatting
- **Deliverable**: `clnrm dry-run` command working
- **Unlocks**: 10% of DX improvement

**Days 7-10: Testing + Docs**
- Day 7: Integration tests (all features)
- Day 8: Performance benchmarks
- Day 9: User documentation
- Day 10: Examples + release prep

---

## Acceptance Criteria

### dev --watch (MUST HAVE)
- [ ] `clnrm dev --watch` starts file watcher
- [ ] Debouncing prevents duplicate runs (300ms default)
- [ ] Terminal clears on each run (`--clear` flag)
- [ ] File save → results in <3s (p95)
- [ ] Errors don't crash watcher
- [ ] Ctrl+C exits cleanly

### Macro pack (MUST HAVE)
- [ ] `_macros.toml.tera` installed to `~/.clnrm/templates/`
- [ ] 5 core macros work: `span`, `lifecycle`, `edges`, `window`, `count`
- [ ] Import with `{% import "_macros.toml.tera" as m %}`
- [ ] Macros render valid TOML
- [ ] Documentation complete

### dry-run (MUST HAVE)
- [ ] `clnrm dry-run tests/*.toml` validates files
- [ ] Validation <1s for 10 files
- [ ] Detects: missing blocks, orphan services, invalid durations
- [ ] Reports errors with file:line:column
- [ ] Exit code 0 (valid) or 1 (errors)

---

## Success Metrics

| Metric | v0.6.0 | v0.7.0 MVP | Improvement |
|--------|--------|-----------|-------------|
| **Edit-run latency** | 15-30s | <3s | **5-10x faster** |
| **Boilerplate/span** | 10 lines | 1 line | **10x less code** |
| **Error detection** | 15-30s | <1s | **15-30x faster** |
| **Auto-rerun** | ❌ Manual | ✅ Automatic | New capability |
| **Template macros** | ❌ None | ✅ 5 macros | New capability |

---

## Dependencies

### Required (Already in Workspace) ✅
- `notify = "6.0"` - File watching

### Optional (Deferred to v0.7.1)
- `toml_edit = "0.22"` - For fmt command

**No new critical dependencies needed!**

---

## Risk Assessment

### Medium Risk
1. **Watch mode on network filesystems (WSL, Docker mounts)**
   - Mitigation: Document limitations, provide polling fallback

2. **Cross-platform file watching (Linux/macOS/Windows)**
   - Mitigation: Test on all platforms before release

3. **Template path resolution on Windows**
   - Mitigation: Use `dirs` crate for cross-platform paths

### Low Risk
- Validation false positives (start with high-priority checks only)
- Macro namespace collisions (use `m::` prefix consistently)
- Debouncing tuning (make configurable via `--debounce-ms`)

---

## Files to Create

### Core Implementation
```
crates/clnrm-core/src/cli/commands/
├── v0_7_0/
│   ├── dev.rs          (dev --watch)
│   ├── dry_run.rs      (dry-run validation)
│   └── mod.rs          (exports)
├── fmt.rs              (DEFERRED)
└── mod.rs              (update exports)

crates/clnrm-core/src/
├── validation/
│   └── shape.rs        (shape validator for dry-run)
└── watch/
    ├── mod.rs          (file watcher)
    └── debouncer.rs    (event debouncing)

templates/
└── _macros.toml.tera   (macro library)
```

### Documentation
```
docs/
├── v0.7.0-requirements-analysis-80-20.md  (this file)
├── v0.7.0-80-20-summary.md                (summary)
├── DEV_MODE_GUIDE.md                      (new)
├── MACRO_REFERENCE.md                     (new)
├── VALIDATION_GUIDE.md                    (new)
└── TERA_TEMPLATES.md                      (update)
```

---

## Migration from v0.6.0

**Breaking Changes**: NONE ✅

All existing workflows work unchanged:
- ✅ `clnrm init`
- ✅ `clnrm run`
- ✅ All `.toml` and `.toml.tera` files

**New Capabilities (Opt-In)**:
```bash
# Old way
clnrm run tests/

# New way (optional)
clnrm dev --watch tests/
```

---

## Macro Pack Examples

### Before (40 lines)
```toml
[[expect.span]]
name = "postgres.start"
kind = "internal"

[[expect.span]]
name = "postgres.exec"
kind = "internal"

[[expect.span]]
name = "postgres.stop"
kind = "internal"

[expect.order]
must_precede = [
  ["postgres.start", "postgres.exec"],
  ["postgres.exec", "postgres.stop"]
]

[[expect.span]]
name = "redis.start"
kind = "internal"

[[expect.span]]
name = "redis.exec"
kind = "internal"

[[expect.span]]
name = "redis.stop"
kind = "internal"

[expect.order]
must_precede = [
  ["redis.start", "redis.exec"],
  ["redis.exec", "redis.stop"]
]
```

### After (2 lines)
```toml
{% import "_macros.toml.tera" as m %}

{{ m::lifecycle("postgres") }}
{{ m::lifecycle("redis") }}
```

**Code Reduction**: 95% less boilerplate!

---

## Next Steps

### For Architecture Sub-Coordinator
1. Review 80/20 prioritization
2. Approve MVP scope (dev, macro, dry-run)
3. Confirm defer decision (fmt, change detection → v0.7.1)
4. Assign implementation tasks

### For Implementation Team
1. **Day 1**: Start `dev --watch` implementation
2. **Day 4**: Start macro pack
3. **Day 6**: Start dry-run
4. **Day 7+**: Testing, docs, polish

### For Documentation Team
1. Draft DEV_MODE_GUIDE.md (Day 3)
2. Draft MACRO_REFERENCE.md (Day 5)
3. Draft VALIDATION_GUIDE.md (Day 6)
4. Update README.md with v0.7.0 highlights (Day 9)

---

## Conclusion

**v0.7.0 MVP delivers 90% of DX value in 2 weeks:**

- ✅ 5-10x faster iteration (dev --watch)
- ✅ 10x less boilerplate (macro pack)
- ✅ 15-30x faster validation (dry-run)
- ✅ No breaking changes
- ✅ No new critical dependencies
- ✅ Low risk, high confidence

**Defer to v0.7.1+:**
- fmt command (5% value, 20% effort)
- Change detection (5% value, 15% effort)

**This 80/20 approach maximizes user value in minimum time.**

---

**Full Analysis**: See `/Users/sac/clnrm/docs/v0.7.0-requirements-analysis-80-20.md` (18 sections, comprehensive)
