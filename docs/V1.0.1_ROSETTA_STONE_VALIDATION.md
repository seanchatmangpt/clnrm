# v1.0.1 Rosetta Stone Validation Report

## Executive Summary

This document describes the comprehensive, hermetic, deterministic test suite designed to provide **100% confidence** for the v1.0.1 release of clnrm. The test suite is based on three "Rosetta Stone" files that define the canonical Homebrew installation validation pattern.

**Status**: üöß Test suite implemented, validation pending

**Release Recommendation**: ‚è≥ Awaiting test execution results

---

## 1. Rosetta Stone Foundation

### 1.1 Source Files

The test suite is derived from three canonical TOML files that represent the complete specification for Homebrew installation validation:

1. **`tests/homebrew_selftest/clnrm_brew_install_selftest_verbose.clnrm.toml`**
   - **Purpose**: Hyper-verbose, line-by-line specification
   - **Lines**: 174
   - **Characteristics**: Complete field documentation, flat TOML structure, stdout OTEL exporter
   - **Key Features**: Determinism config, hermetic validation, span graph topology

2. **`examples/integration-tests/homebrew-install-selftest.clnrm.toml`**
   - **Purpose**: Structured validation with comprehensive expectations
   - **Lines**: 163
   - **Characteristics**: Step-by-step installation validation, OTEL span validation
   - **Key Features**: Graph structure validation, status code validation, hermeticity checks

3. **`tests/readme_examples/install_homebrew.clnrm.toml`**
   - **Purpose**: README example validation
   - **Lines**: 46
   - **Characteristics**: Simplified validation matching documentation
   - **Key Features**: Installation verification, version checking

### 1.2 Core Validation Patterns Extracted

From these Rosetta Stone files, we extracted these critical validation patterns:

#### Determinism Configuration
```toml
[determinism]
seed = 42
freeze_clock = "2025-01-01T00:00:00Z"
normalize_output = true
exclude_fields = ["timestamp", "container_id", "span_id", "trace_id", "uuid"]
```

#### OTEL-First Validation (No Exit Codes)
```toml
[[expect.span]]
name = "clnrm.run"
kind = "internal"
attrs.all = { "result" = "pass" }

[[expect.span]]
name = "clnrm.step:hello_world"
parent = "clnrm.run"
kind = "internal"
events.any = ["container.start", "container.exec", "container.stop"]
```

#### Graph Topology
```toml
[expect.graph]
must_include = [["clnrm.run", "clnrm.step:hello_world"]]
acyclic = true
```

#### Hermeticity Validation
```toml
[expect.hermeticity]
no_external_services = true
no_shared_state = true
no_container_reuse = true
span_attrs.forbid_keys = ["net.peer.name", "db.connection_string", "http.url"]
```

---

## 2. Test Suite Architecture

### 2.1 Directory Structure

```
tests/v1.0.1_release/
‚îú‚îÄ‚îÄ rosetta_stone_suite.clnrm.toml          # Master orchestration
‚îú‚îÄ‚îÄ scenario_01_minimal.clnrm.toml          # Minimal validation
‚îú‚îÄ‚îÄ scenario_02_full_surface.clnrm.toml     # All self-test suites
‚îú‚îÄ‚îÄ scenario_03_otlp.clnrm.toml             # OTLP collector integration
‚îú‚îÄ‚îÄ scenario_04_hermetic.clnrm.toml         # Isolation verification
‚îú‚îÄ‚îÄ scenario_05_determinism.clnrm.toml      # 5-iteration validation
‚îî‚îÄ‚îÄ README.md                                # Suite documentation
```

### 2.2 Test Scenarios

#### Scenario 01: Minimal Validation
- **Purpose**: Smoke test for basic Homebrew installation
- **Validation**: Basic span graph with root + step span
- **Command**: `clnrm self-test --suite basic --otel-exporter stdout`
- **Expected Spans**: `clnrm.run`, `clnrm.step:hello_world`
- **Timeout**: 10 minutes
- **Weight**: 1.0

#### Scenario 02: Full Surface Validation
- **Purpose**: Comprehensive validation of all framework capabilities
- **Validation**: All self-test suites (basic, container, service, otel)
- **Command**: `clnrm self-test --suite basic --suite container --suite service --suite otel`
- **Expected Spans**: 10+ spans covering all suites
- **Timeout**: 20 minutes
- **Weight**: 1.5

#### Scenario 03: OTLP Collector Integration
- **Purpose**: End-to-end telemetry pipeline validation
- **Validation**: OTLP exporter with Jaeger collector
- **Infrastructure**: Jaeger all-in-one container
- **Expected Spans**: Includes `clnrm.otel.export` span
- **Timeout**: 15 minutes
- **Weight**: 1.0

#### Scenario 04: Hermetic Isolation Verification
- **Purpose**: Detect state leakage across sequential runs
- **Validation**: 3 sequential runs with isolation checks
- **Expected Behavior**: Each run independent, no shared state
- **Verification**: Unique container IDs, no cache hits, no persistent state
- **Timeout**: 15 minutes
- **Weight**: 2.0

#### Scenario 05: Determinism Validation (kcura pattern)
- **Purpose**: Verify bit-identical results across iterations
- **Validation**: 5 iterations with normalized hash comparison
- **Expected Behavior**: All 5 iterations produce identical hashes
- **Normalization**: Exclude timestamps, container IDs, span IDs, trace IDs, UUIDs
- **Timeout**: 20 minutes
- **Weight**: 2.5

### 2.3 Weight-Based Confidence Calculation

Total weight: **8.0** (sum of all scenario weights)

**Formula**:
```
Confidence = (Œ£ passed_scenario_weights / total_weight) √ó 100%
```

**Release Criteria**: Confidence ‚â• 100% (all scenarios must pass)

---

## 3. Hermetic Isolation Requirements

### 3.1 Container Isolation

Each test scenario runs in a **fresh container** with:
- No shared volumes
- No shared networks (except Homebrew fetch)
- Unique container ID per run
- Complete cleanup after execution

**Verification**:
- Container ID uniqueness check
- No persistent state detection
- No cache hit attributes in spans

### 3.2 State Leakage Detection

**Forbidden Span Attributes** (indicate leakage):
- `cache.hit`
- `previous_run`
- `net.peer.name` (except OTLP collector)
- `db.connection_string`
- `http.url` (except Homebrew installation)

**Container Cleanup Policy**:
- Always cleanup containers after each run
- Prune networks and volumes
- Verify no orphaned containers remain

### 3.3 Network Isolation

**Allowed Network Operations**:
- Homebrew formula fetch (installation only)
- OTLP collector communication (scenario 03 only)

**Forbidden Network Operations**:
- External API calls in spans
- Database connections
- HTTP requests from test code

---

## 4. Determinism Implementation

### 4.1 kcura 5-Iteration Pattern

Based on kcura's determinism validation approach:

```rust
const ITERATIONS: usize = 5;
for i in 0..ITERATIONS {
    let result = run_test().await?;
    let normalized = normalize_spans(&result);
    let hash = calculate_hash(&normalized);
    hashes.push(hash);
}
assert!(hashes.windows(2).all(|w| w[0] == w[1]));
```

### 4.2 Normalization Strategy

**Excluded Fields** (non-deterministic):
- `timestamp` - Wall-clock time
- `container_id` - Unique per container
- `span_id` - Unique per span
- `trace_id` - Unique per trace
- `uuid` - Any UUID fields
- `duration_ns` - Execution time variance

**Preserved Fields** (deterministic):
- Span names
- Span kinds
- Parent-child relationships
- Event names
- Status codes
- Deterministic attributes

### 4.3 Hash Calculation

**Algorithm**: SHA-256

**Input**: JSON-serialized normalized span graph

**Process**:
1. Normalize spans (remove non-deterministic fields)
2. Sort attributes alphabetically
3. Serialize to JSON
4. Calculate SHA-256 hash
5. Convert to hex string

**Expected Output**: All 5 iterations produce identical hashes

---

## 5. OTEL-First Validation

### 5.1 Span-Based Proof (Not Exit Codes)

**Critical Principle**: Proof of correctness comes from **spans**, not exit codes.

**Why**:
- Exit code 0 can be fake (empty `Ok(())` implementations)
- Spans prove actual execution happened
- Span graphs prove correct sequencing
- Span attributes prove expected outcomes

### 5.2 Required Span Validations

#### Root Span
```toml
[[expect.span]]
name = "clnrm.run"
kind = "internal"
attrs.all = { "result" = "pass" }
duration_ms = { min = 10, max = 600000 }
```

**Proves**: Test ran and passed

#### Step Span
```toml
[[expect.span]]
name = "clnrm.step:hello_world"
parent = "clnrm.run"
kind = "internal"
events.any = ["container.start", "container.exec", "container.stop"]
```

**Proves**: Actual container execution (not fake green)

#### Graph Topology
```toml
[expect.graph]
must_include = [["clnrm.run", "clnrm.step:hello_world"]]
acyclic = true
```

**Proves**: Correct parent-child relationships, no cycles

### 5.3 Span Count Validation

```toml
[expect.counts]
spans_total = { gte = 2, lte = 200 }
errors_total = { eq = 0 }
by_name = {
    "clnrm.run" = { eq = 1 },
    "clnrm.step:hello_world" = { gte = 1 }
}
```

**Proves**: Expected span cardinality, no errors, no duplication

### 5.4 Status Validation

```toml
[expect.status]
all = "OK"
```

**Proves**: All spans succeeded, no hidden failures

---

## 6. Rust Test Runner

### 6.1 Implementation

**File**: `/crates/clnrm-core/tests/v1_release_confidence.rs`

**Key Functions**:
- `run_toml_test(test_file)` - Execute TOML test file
- `normalize_spans(result)` - Remove non-deterministic fields
- `calculate_hash(spans)` - SHA-256 hash of normalized spans
- `cleanup_test_containers()` - Container cleanup between runs
- `validate_determinism(test_file)` - 5-iteration validation

**Test Functions**:
- `test_scenario_01_minimal_is_deterministic()` - Scenario 01 + determinism
- `test_scenario_02_full_surface_validation()` - Scenario 02 validation
- `test_scenario_04_hermetic_isolation()` - Scenario 04 isolation checks
- `test_full_release_confidence_suite()` - Complete suite with report

### 6.2 Test Execution

```bash
# Run determinism validation for Scenario 01
cargo test --test v1_release_confidence test_scenario_01_minimal_is_deterministic

# Run full surface validation (Scenario 02)
cargo test --test v1_release_confidence test_scenario_02_full_surface_validation

# Run hermetic isolation validation (Scenario 04)
cargo test --test v1_release_confidence test_scenario_04_hermetic_isolation

# Run complete release confidence suite
cargo test --test v1_release_confidence test_full_release_confidence_suite

# Generate release confidence report
cargo test --test v1_release_confidence -- --nocapture > release_confidence.txt
```

### 6.3 Report Generation

**Output**: `target/v1.0.1_release_confidence.json`

**Format**:
```json
{
  "version": "1.0.1",
  "scenarios": [
    {
      "name": "01_minimal_validation",
      "passed": true,
      "span_count": 5,
      "errors": 0,
      "hermetic": true
    }
  ],
  "determinism_results": [
    {
      "scenario": "scenario_01_minimal.clnrm.toml",
      "iterations": 5,
      "hashes": ["abc123...", "abc123...", "abc123...", "abc123...", "abc123..."],
      "is_deterministic": true,
      "confidence": 1.0
    }
  ],
  "total_confidence": 100.0,
  "recommendation": "‚úÖ SHIP v1.0.1 - 100% CONFIDENCE"
}
```

---

## 7. Pass Criteria for v1.0.1 Release

### 7.1 All Criteria Must Be True

- [ ] **Scenario 01** (Minimal): Passes
- [ ] **Scenario 02** (Full Surface): Passes
- [ ] **Scenario 03** (OTLP): Passes
- [ ] **Scenario 04** (Hermetic): Passes, no state leakage detected
- [ ] **Scenario 05** (Determinism): Passes, 5/5 hashes identical
- [ ] **Span Validations**: All required spans present
- [ ] **Graph Topology**: Acyclic, correct edges
- [ ] **Span Counts**: Within expected ranges
- [ ] **Error Count**: Zero errors across all scenarios
- [ ] **Status**: All spans have OK status
- [ ] **Hermeticity**: No forbidden attributes in spans
- [ ] **Container Cleanup**: All containers removed
- [ ] **Homebrew Install**: Succeeds in container
- [ ] **Self-Test**: Passes with OTEL validation
- [ ] **Total Confidence**: 100% (8.0/8.0 weighted score)

### 7.2 Release Decision Matrix

| Confidence | Recommendation | Action |
|-----------|----------------|--------|
| 100% | ‚úÖ SHIP v1.0.1 - 100% CONFIDENCE | Release approved |
| 80-99% | ‚ö†Ô∏è REVIEW v1.0.1 - HIGH CONFIDENCE WITH WARNINGS | Review failures, consider release |
| < 80% | ‚ùå BLOCK v1.0.1 - FAILURES DETECTED | Block release, fix issues |

---

## 8. Validation Results

### 8.1 Test Execution Status

**Status**: ‚è≥ Awaiting execution

**Command**:
```bash
cargo test --test v1_release_confidence test_full_release_confidence_suite -- --nocapture
```

### 8.2 Scenario Results

| Scenario | Status | Spans | Errors | Hermetic | Deterministic |
|----------|--------|-------|--------|----------|---------------|
| 01_minimal | ‚è≥ Pending | - | - | - | - |
| 02_full_surface | ‚è≥ Pending | - | - | - | - |
| 03_otlp | ‚è≥ Pending | - | - | - | - |
| 04_hermetic | ‚è≥ Pending | - | - | - | - |
| 05_determinism | ‚è≥ Pending | - | - | - | - |

### 8.3 Determinism Hash Results

**Scenario 01 (5 iterations)**:
```
Iteration 1: [pending]
Iteration 2: [pending]
Iteration 3: [pending]
Iteration 4: [pending]
Iteration 5: [pending]
Match: [pending]
```

### 8.4 Hermetic Isolation Results

**Scenario 04 (3 sequential runs)**:
```
Run 1: [pending]
  Container ID: [pending]
  State leakage: [pending]

Run 2: [pending]
  Container ID: [pending]
  State leakage: [pending]

Run 3: [pending]
  Container ID: [pending]
  State leakage: [pending]

Isolation verified: [pending]
```

---

## 9. Release Confidence Assessment

### 9.1 Current Confidence

**Total Confidence**: ‚è≥ Awaiting results

**Weight Breakdown**:
- Scenario 01 (weight 1.0): [pending]
- Scenario 02 (weight 1.5): [pending]
- Scenario 03 (weight 1.0): [pending]
- Scenario 04 (weight 2.0): [pending]
- Scenario 05 (weight 2.5): [pending]

**Total Weight**: 8.0

### 9.2 Final Recommendation

**Status**: ‚è≥ Awaiting test execution

**Expected Outcome**: ‚úÖ SHIP v1.0.1 - 100% CONFIDENCE

**Rationale**:
- Comprehensive hermetic test suite implemented
- Determinism validation with 5-iteration pattern
- OTEL-first validation (spans, not exit codes)
- Based on proven Rosetta Stone patterns
- Complete isolation and cleanup verification

---

## 10. Appendix

### 10.1 Running the Full Suite

```bash
# Step 1: Build clnrm with OTEL features
cargo build --release --features otel

# Step 2: Install via Homebrew (for dogfooding)
brew uninstall clnrm  # if already installed
brew install --build-from-source .

# Step 3: Run TOML-based suite
clnrm run tests/v1.0.1_release/rosetta_stone_suite.clnrm.toml

# Step 4: Run Rust determinism tests
cargo test --test v1_release_confidence

# Step 5: Generate release report
cargo test --test v1_release_confidence test_full_release_confidence_suite -- --nocapture > release_confidence.txt
```

### 10.2 Files Created

1. `/tests/v1.0.1_release/rosetta_stone_suite.clnrm.toml`
2. `/tests/v1.0.1_release/scenario_01_minimal.clnrm.toml`
3. `/tests/v1.0.1_release/scenario_02_full_surface.clnrm.toml`
4. `/tests/v1.0.1_release/scenario_03_otlp.clnrm.toml`
5. `/tests/v1.0.1_release/scenario_04_hermetic.clnrm.toml`
6. `/tests/v1.0.1_release/scenario_05_determinism.clnrm.toml`
7. `/crates/clnrm-core/tests/v1_release_confidence.rs`
8. `/docs/V1.0.1_ROSETTA_STONE_VALIDATION.md` (this file)
9. `/tests/v1.0.1_release/README.md`

### 10.3 Success Criteria Summary

**To ship v1.0.1, ALL must be true**:
1. All 5 scenarios pass
2. Determinism test shows 5/5 identical hashes
3. Zero hermetic isolation violations
4. All span validations pass
5. Span graphs are acyclic
6. `errors_total == 0` in all runs
7. No container leakage detected
8. Homebrew installation succeeds
9. Self-test passes with OTEL validation
10. Report shows "‚úÖ SHIP v1.0.1 - 100% CONFIDENCE"

---

**Document Version**: 1.0
**Date**: 2025-01-17
**Status**: Test suite implemented, validation pending
**Next Action**: Execute test suite and update results sections
