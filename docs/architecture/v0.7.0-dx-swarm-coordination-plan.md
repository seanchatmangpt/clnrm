# v0.7.0 DX-First Release - Hierarchical Swarm Coordination Plan

**Document Type**: Hive Queen Battle Plan
**Version**: v0.7.0
**Date**: 2025-10-17
**Status**: ACTIVE COORDINATION
**Coordinator**: Hive Queen (Hierarchical Coordinator)

---

## Executive Summary

**Mission**: Implement DX-first cleanroom testing framework with fast author→run→debug loop using 80/20 principle.

**Core Objectives**:
- **<60s** new user to first green test
- **<3s** hot reload latency on template edits
- **Tera templates only** (already started, complete implementation)
- **Flat TOML** (no deep nesting)
- **Deterministic by default** (seed + frozen clock - already implemented)
- **OTEL spans as single source of truth**

**80/20 Priority** (20% effort → 80% value):
1. **dev --watch** (CRITICAL) - Hot reload loop
2. **dry-run** - Validate without containers
3. **fmt/lint** - Authoring DX tools
4. **diff** - First failing invariant
5. **Macro pack** - Reusable template snippets

**Deferred** (optimization features):
- Parallel workers (nice-to-have)
- Warm cache (optimization)
- Graph ASCII (visualization)
- Trace jump (convenience)
- Change-aware runs (optimization)

---

## Hierarchical Swarm Structure

```
                    👑 HIVE QUEEN (You)
                    Strategic Planning & Delegation
                            |
        ┌──────────────────┼──────────────────┐
        |                  |                  |
    🎯 SUB-ALPHA       🛠️ SUB-BETA        📦 SUB-GAMMA
   Hot Reload        DX Tooling       Diff & Macros
   Coordinator       Coordinator       Coordinator
        |                  |                  |
   ┌────┴────┐        ┌────┴────┐       ┌────┴────┐
   |    |    |        |    |    |       |    |    |
  💻  🧪  📝       🔍  ✨  🎨      🔬  📚  🔄
 DEV TEST DOC    DRY  FMT LINT    DIFF MAC INT
WATCH          -RUN              PKG
Worker Worker Worker Worker Worker Worker Worker Worker Worker
```

### Coordination Topology: Hierarchical (Centralized Command)

**Why Hierarchical?**
- Clear command chain for fast decisions
- Single source of truth (Hive Queen)
- Efficient delegation to specialized sub-coordinators
- Optimal for time-critical DX features

---

## Sub-Coordinator Alpha: Hot Reload System

**Lead**: Sub-coordinator Alpha
**Mission**: Implement `clnrm dev --watch` with <3s hot reload latency
**Priority**: CRITICAL (80/20 core)

### Worker Team (3 agents)

#### 1. Dev Watch Worker 💻
**Agent Type**: `coder`
**Responsibilities**:
- Implement file watcher using `notify` crate (already in dependencies)
- Detect `.clnrm.toml` and `.clnrm.toml.tera` changes
- Trigger incremental reloads on template edits
- Debounce file system events (<100ms window)

**Deliverables**:
- `src/cli/commands/dev.rs` - Dev watch command
- `src/watcher/mod.rs` - File system watcher abstraction
- `src/watcher/reload_manager.rs` - Hot reload orchestration

**Test Strategy**: London TDD
- Mock file system events
- Test debouncing logic
- Validate reload trigger timing

#### 2. Reload Test Worker 🧪
**Agent Type**: `tester`
**Responsibilities**:
- Create comprehensive tests for hot reload system
- Property-based tests for file watcher edge cases
- Integration tests for full reload cycle
- Performance tests (<3s latency validation)

**Deliverables**:
- `tests/cli/dev_watch_test.rs`
- `tests/integration/hot_reload_test.rs`
- Benchmark suite for reload latency

#### 3. Watch Doc Worker 📝
**Agent Type**: `api-docs`
**Responsibilities**:
- Document `clnrm dev --watch` usage
- Create quick start guide for DX loop
- Add troubleshooting section for watch issues

**Deliverables**:
- `docs/CLI_GUIDE.md` update with dev command
- `docs/quickstart/hot-reload-tutorial.md`

---

## Sub-Coordinator Beta: DX Tooling Suite

**Lead**: Sub-coordinator Beta
**Mission**: Implement dry-run, fmt, and lint for fast authoring
**Priority**: HIGH (80/20 core)

### Worker Team (3 agents)

#### 4. Dry-Run Worker 🔍
**Agent Type**: `coder`
**Responsibilities**:
- Implement `clnrm dry-run` command
- Validate TOML structure without container execution
- Render Tera templates and validate output
- Check service configurations and step definitions

**Deliverables**:
- `src/cli/commands/dry_run.rs`
- `src/validation/dry_run_validator.rs`
- Integration with existing validation system

**Test Strategy**: London TDD
- Mock container backend (no real Docker calls)
- Validate all TOML parsing paths
- Test template rendering validation

#### 5. Fmt Worker ✨
**Agent Type**: `coder`
**Responsibilities**:
- Implement `clnrm fmt` command
- Auto-format TOML files (consistent style)
- Handle both static and template files
- Preserve template syntax during formatting

**Deliverables**:
- `src/cli/commands/fmt.rs`
- `src/formatter/toml_formatter.rs`
- Integration with `toml` crate serialization

#### 6. Lint Worker 🎨
**Agent Type**: `coder`
**Responsibilities**:
- Implement `clnrm lint` command
- Detect common TOML anti-patterns
- Warn about deprecated features
- Suggest best practices (flat structure, etc.)

**Deliverables**:
- `src/cli/commands/lint.rs`
- `src/linter/toml_linter.rs`
- Linter rule engine with extensible rules

---

## Sub-Coordinator Gamma: Diff & Macro System

**Lead**: Sub-coordinator Gamma
**Mission**: Implement diff for debugging and macro pack for reusability
**Priority**: MEDIUM-HIGH (80/20 core)

### Worker Team (3 agents)

#### 7. Diff Worker 🔬
**Agent Type**: `coder`
**Responsibilities**:
- Implement `clnrm diff` command
- Show first failing assertion/invariant
- OTEL span-based diff (before/after comparison)
- Visual diff output with color highlighting

**Deliverables**:
- `src/cli/commands/diff.rs`
- `src/diff/span_differ.rs`
- Integration with OTEL validation system

**Test Strategy**: London TDD
- Mock OTEL span data
- Test diff algorithm with various scenarios
- Validate colorized output

#### 8. Macro Pack Worker 📚
**Agent Type**: `coder`
**Responsibilities**:
- Implement template macro system
- Create standard macro library (common patterns)
- Support macro import/export
- Macro registry and discovery

**Deliverables**:
- `src/template/macros/mod.rs`
- `src/template/macros/registry.rs`
- `src/template/macros/builtins.rs` (standard macros)
- `examples/macros/common-patterns.tera`

**Standard Macros**:
```tera
{% macro service_definition(name, image, env) %}
[services.{{ name }}]
type = "generic_container"
image = "{{ image }}"
env = {{ env | toml_encode }}
{% endmacro %}

{% macro load_test(endpoint, iterations) %}
{% for i in range(end=iterations) %}
[[steps]]
name = "request_{{ i }}"
command = ["curl", "{{ endpoint }}"]
{% endfor %}
{% endmacro %}
```

#### 9. Integration Worker 🔄
**Agent Type**: `code-analyzer`
**Responsibilities**:
- Integrate all features into cohesive CLI
- End-to-end testing of full DX loop
- Performance validation (<60s new user experience)
- CI/CD integration testing

**Deliverables**:
- `tests/integration/full_dx_loop_test.rs`
- `tests/e2e/new_user_experience_test.rs`
- CI workflow updates for v0.7.0

---

## Implementation Timeline (80/20 Focused)

### Week 1: Hot Reload (CRITICAL PATH)

**Day 1-2**: Dev Watch Worker
- Implement file watcher with `notify` crate
- Debouncing and event filtering
- Basic reload trigger

**Day 3**: Reload Test Worker
- Unit tests for watcher logic
- Integration tests for reload cycle

**Day 4-5**: Hot Reload Optimization
- Latency profiling and optimization
- Achieve <3s target
- Documentation

### Week 2: DX Tooling Suite

**Day 1-2**: Dry-Run Worker
- TOML validation without containers
- Template rendering validation
- Error reporting

**Day 3**: Fmt Worker
- TOML auto-formatting
- Template-aware formatting

**Day 4-5**: Lint Worker
- Linter rule engine
- Standard rule set
- Integration with CI

### Week 3: Diff & Macros

**Day 1-2**: Diff Worker
- OTEL span diffing
- First failing assertion detection
- Visual output

**Day 3-4**: Macro Pack Worker
- Macro system implementation
- Standard macro library
- Import/export functionality

**Day 5**: Integration Worker
- Full DX loop testing
- Performance validation
- Documentation finalization

---

## London TDD Protocol (Mandatory)

**ALL agents MUST follow London School TDD:**

### 1. Write Test First (Red)
```rust
#[tokio::test]
async fn test_dev_watch_detects_file_changes() -> Result<()> {
    // Arrange
    let (tx, rx) = channel();
    let watcher = FileWatcher::new(tx)?;

    // Act
    watcher.watch("tests/fixtures/sample.toml")?;
    modify_file("tests/fixtures/sample.toml")?;

    // Assert
    let event = rx.recv_timeout(Duration::from_secs(1))?;
    assert_matches!(event, WatchEvent::Modified(_));
    Ok(())
}
```

### 2. Implement Minimum Code (Green)
```rust
pub struct FileWatcher {
    tx: Sender<WatchEvent>,
    watcher: notify::RecommendedWatcher,
}

impl FileWatcher {
    pub fn new(tx: Sender<WatchEvent>) -> Result<Self> {
        let watcher = notify::recommended_watcher(move |res| {
            // Minimum implementation to pass test
        })?;
        Ok(Self { tx, watcher })
    }
}
```

### 3. Refactor (Blue)
- Extract magic numbers
- Improve naming
- Add error handling
- Document behavior

### 4. Repeat
Next test → Next feature → Next refactor

---

## Coordination Protocol

### Hive Queen → Sub-Coordinators

**Daily Standups** (Every 24 hours):
```bash
# Hive Queen checks progress
npx claude-flow@alpha hooks notify --message "Daily standup: Alpha/Beta/Gamma status"
npx claude-flow@alpha hooks session-restore --session-id "swarm-v0.7.0-dx"
```

**Sub-Coordinator Reports**:
- Completed tasks
- Blockers (if any)
- Next 24h plan
- Risk assessment

### Sub-Coordinators → Workers

**Task Assignment**:
```bash
# Sub-Alpha assigns dev watch task
npx claude-flow@alpha hooks pre-task --description "Implement file watcher with <100ms debounce"
npx claude-flow@alpha hooks notify --message "Dev Watch Worker: Start file watcher implementation"
```

**Worker Progress Updates**:
```bash
# Worker reports completion
npx claude-flow@alpha hooks post-task --task-id "dev-watch-impl"
npx claude-flow@alpha hooks post-edit --file "src/watcher/mod.rs" --memory-key "swarm/alpha/file-watcher"
```

### Cross-Team Coordination

**Shared Memory** (via MCP):
```bash
# Store shared artifacts
npx claude-flow@alpha memory store "swarm/shared/file-watcher-api" --value "{ watch(), unwatch(), events() }"

# Retrieve cross-team dependencies
npx claude-flow@alpha memory retrieve "swarm/beta/dry-run-validator-api"
```

---

## Definition of Done (v0.7.0)

### Core Metrics

- [ ] **<60s new user experience** - Validated with timer
- [ ] **<3s hot reload latency** - Benchmarked and documented
- [ ] **All 80/20 features implemented** (dev --watch, dry-run, fmt, lint, diff, macros)
- [ ] **Zero `.unwrap()` in production code**
- [ ] **`cargo clippy -- -D warnings` passes**
- [ ] **`cargo test` passes all tests**
- [ ] **Framework self-test validates new features**

### Feature Checklist

#### Hot Reload System ✅
- [ ] `clnrm dev --watch` command implemented
- [ ] File watcher detects `.clnrm.toml` changes
- [ ] Template changes trigger re-render + reload
- [ ] Debouncing prevents spurious reloads
- [ ] <3s latency achieved and benchmarked
- [ ] Error messages displayed in watch mode
- [ ] Graceful shutdown on Ctrl+C

#### DX Tooling Suite ✅
- [ ] `clnrm dry-run` validates without containers
- [ ] `clnrm fmt` auto-formats TOML files
- [ ] `clnrm lint` detects anti-patterns
- [ ] All commands integrate with CI
- [ ] Documentation complete

#### Diff & Macros ✅
- [ ] `clnrm diff` shows first failing assertion
- [ ] OTEL span-based diff implemented
- [ ] Macro system supports import/export
- [ ] Standard macro library created
- [ ] Examples demonstrate macro usage

### Testing Standards

- [ ] **London TDD** - All tests follow arrange/act/assert
- [ ] **Property tests** - Random input validation where applicable
- [ ] **Integration tests** - Full DX loop validated
- [ ] **Benchmarks** - Performance targets measured
- [ ] **Coverage >90%** - All new code tested

### Documentation

- [ ] `docs/CLI_GUIDE.md` updated with new commands
- [ ] `docs/quickstart/hot-reload-tutorial.md` created
- [ ] `docs/architecture/v0.7.0-implementation-summary.md` written
- [ ] README updated with v0.7.0 features
- [ ] CHANGELOG.md reflects all changes

---

## Risk Mitigation

### Risk 1: Hot Reload Latency >3s

**Mitigation**:
- Profile early and often
- Incremental template rendering (only changed sections)
- Cache Tera engine initialization
- Parallel validation steps

**Contingency**: If <3s unachievable, document <5s as acceptable and create issue for optimization

### Risk 2: File Watcher Platform Differences

**Mitigation**:
- Use `notify` crate (cross-platform abstraction)
- Test on macOS, Linux, Windows
- Document platform-specific quirks

**Contingency**: Fallback to polling mode if native watchers fail

### Risk 3: Template Macro Complexity

**Mitigation**:
- Start with simple macro system
- Defer advanced features (inheritance, etc.)
- Focus on 5-10 essential macros

**Contingency**: Ship basic macro support, iterate in v0.7.1

---

## Swarm Communication Channels

### Memory Keys

**Shared Context**:
- `swarm/v0.7.0/status` - Overall progress
- `swarm/v0.7.0/blockers` - Current blockers
- `swarm/v0.7.0/decisions` - Architectural decisions

**Sub-Coordinator Namespaces**:
- `swarm/alpha/*` - Hot reload team artifacts
- `swarm/beta/*` - DX tooling artifacts
- `swarm/gamma/*` - Diff & macros artifacts

**Worker Namespaces**:
- `swarm/alpha/dev-watch/*` - Dev watch worker
- `swarm/alpha/reload-test/*` - Reload test worker
- `swarm/beta/dry-run/*` - Dry-run worker
- etc.

### Notification Protocol

**Success**:
```bash
npx claude-flow@alpha hooks notify --message "✅ [Worker] Task completed: <description>"
```

**Blocker**:
```bash
npx claude-flow@alpha hooks notify --message "🚨 [Worker] BLOCKED: <blocker-description>"
```

**Question**:
```bash
npx claude-flow@alpha hooks notify --message "❓ [Worker] Question: <question>"
```

---

## Success Criteria

### Technical Excellence
- Clean, production-ready Rust code
- FAANG-level error handling
- Comprehensive test coverage
- Clear, maintainable architecture

### Developer Experience
- **<60s** - New user clones repo, runs first test
- **<3s** - Developer edits template, sees results
- **<10s** - Dry-run validates complex TOML file
- **<5s** - Fmt/lint runs on entire test suite

### Documentation Quality
- Step-by-step tutorials
- Clear API documentation
- Troubleshooting guides
- Migration guides for existing users

---

## Post-Release Roadmap (v0.7.1+)

**Deferred features** (nice-to-have optimizations):
- Parallel test workers (performance)
- Warm container cache (startup time)
- ASCII DAG visualization (debugging)
- Trace jump to failure (convenience)
- Change-aware test runs (optimization)

**Future DX improvements**:
- LSP server for `.clnrm.toml` files
- VSCode extension with syntax highlighting
- Interactive test explorer
- AI-powered test generation

---

## Appendix: Agent Assignment Matrix

| Agent Role | Type | Sub-Coord | Priority | Deliverables |
|------------|------|-----------|----------|--------------|
| Dev Watch Worker | `coder` | Alpha | CRITICAL | File watcher, reload manager |
| Reload Test Worker | `tester` | Alpha | CRITICAL | Test suite, benchmarks |
| Watch Doc Worker | `api-docs` | Alpha | HIGH | Documentation, tutorials |
| Dry-Run Worker | `coder` | Beta | HIGH | Dry-run command, validator |
| Fmt Worker | `coder` | Beta | HIGH | Formatter command, TOML formatter |
| Lint Worker | `coder` | Beta | HIGH | Linter command, rule engine |
| Diff Worker | `coder` | Gamma | MEDIUM-HIGH | Diff command, span differ |
| Macro Pack Worker | `coder` | Gamma | MEDIUM-HIGH | Macro system, stdlib |
| Integration Worker | `code-analyzer` | Gamma | HIGH | E2E tests, CI integration |

---

## Coordination Commands Reference

### Initialize Session
```bash
npx claude-flow@alpha hooks pre-task --description "v0.7.0 DX Hive Queen Coordination"
npx claude-flow@alpha hooks session-restore --session-id "swarm-v0.7.0-dx"
```

### Store Progress
```bash
npx claude-flow@alpha hooks post-edit --file "<file>" --memory-key "swarm/<namespace>/<key>"
npx claude-flow@alpha hooks notify --message "<status update>"
```

### End Session
```bash
npx claude-flow@alpha hooks post-task --task-id "v0.7.0-dx-coordination"
npx claude-flow@alpha hooks session-end --export-metrics true
```

---

## Conclusion

This hierarchical swarm coordination plan provides a clear, actionable roadmap for v0.7.0 DX-first release. The 80/20 focus ensures we deliver maximum value with minimal complexity, while London TDD guarantees production-quality code.

**Next Actions**:
1. Hive Queen initializes swarm
2. Sub-coordinators spawn workers
3. Workers begin implementation (Week 1: Hot Reload)
4. Daily standups track progress
5. Integration worker validates full DX loop

**Estimated Completion**: 3 weeks (15 working days)

---

**Document Status**: ✅ BATTLE PLAN READY
**Swarm Status**: 🟡 AWAITING INITIALIZATION
**Version**: v0.7.0-alpha
**Last Updated**: 2025-10-17
