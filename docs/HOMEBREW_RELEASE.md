# Homebrew Release Process

This document outlines the complete process for releasing the Cleanroom CLI through Homebrew, including both custom tap and homebrew-core distribution.

## Overview

The Cleanroom CLI is distributed through Homebrew in two ways:
1. **Custom Tap**: `brew install seanchatmangpt/clnrm/clnrm` (immediate availability)
2. **Homebrew Core**: `brew install clnrm` (official repository, requires approval)

## Release Types

### Custom Tap Release (Recommended for immediate distribution)

**Advantages:**
- Immediate availability after release
- Full control over formula and updates
- Can include beta/alpha releases
- No approval process required

**Installation:**
```bash
brew tap seanchatmangpt/clnrm
brew install clnrm
```

### Homebrew Core Release (For official distribution)

**Advantages:**
- Official Homebrew repository
- No tap required for installation
- Higher visibility and trust
- Automatic updates through Homebrew

**Installation:**
```bash
brew install clnrm
```

## Release Process

### 1. Pre-Release Checklist

Before creating a release, ensure:

- [ ] All tests pass: `cargo test`
- [ ] CLI builds successfully: `cargo build --release`
- [ ] Version is updated in `Cargo.toml`
- [ ] CHANGELOG.md is updated
- [ ] Documentation is current
- [ ] No breaking changes without migration plan

### 2. Create GitHub Release

1. **Tag the release:**
   ```bash
   git tag -a v0.3.0 -m "Release v0.3.0"
   git push origin v0.3.0
   ```

2. **Create GitHub release:**
   - Go to GitHub repository → Releases → Create a new release
   - Tag: `v0.3.0`
   - Title: `Cleanroom CLI v0.3.0`
   - Description: Copy from CHANGELOG.md
   - Attach source tarball (auto-generated by GitHub)

### 3. Automated Bottle Building

The GitHub Actions workflow (`.github/workflows/homebrew-release.yml`) automatically:

1. **Builds bottles for multiple platforms:**
   - macOS ARM64 (Apple Silicon)
   - macOS x86_64 (Intel)
   - Linux x86_64

2. **Calculates SHA256 checksums** for each bottle

3. **Uploads bottles as release assets**

4. **Validates formula syntax** with `brew audit --strict`

### 4. Update Formula

After the automated build completes:

1. **Get the source tarball SHA256:**
   ```bash
   curl -L https://github.com/seanchatmangpt/clnrm/archive/refs/tags/v0.3.0.tar.gz | shasum -a 256
   ```

2. **Update `homebrew/Formula/clnrm.rb`:**
   - Update `url` with new version
   - Update `sha256` with source tarball hash
   - Update bottle `sha256` hashes from workflow output

3. **Update `homebrew/homebrew-core-formula/clnrm.rb`** with same changes

### 5. Test Formula

Test the formula locally:

```bash
# Test formula syntax
brew audit --strict homebrew/Formula/clnrm.rb

# Test source installation
brew install --build-from-source homebrew/Formula/clnrm.rb

# Test bottle installation (if available)
brew uninstall clnrm
brew install homebrew/Formula/clnrm.rb

# Test functionality
clnrm --version
clnrm --help
clnrm init test-project
clnrm validate test-project/cleanroom.toml
```

### 6. Deploy Custom Tap

1. **Create tap repository** (if not exists):
   ```bash
   # Create new repository: homebrew-clnrm
   # Clone and set up structure
   git clone https://github.com/seanchatmangpt/homebrew-clnrm.git
   cd homebrew-clnrm
   mkdir -p Formula
   ```

2. **Copy formula to tap:**
   ```bash
   cp /path/to/clnrm/homebrew/Formula/clnrm.rb Formula/
   ```

3. **Commit and push:**
   ```bash
   git add Formula/clnrm.rb
   git commit -m "clnrm 0.3.0"
   git push origin main
   ```

### 7. Homebrew Core Submission (Optional)

For official Homebrew inclusion:

1. **Fork homebrew-core:**
   ```bash
   git clone https://github.com/Homebrew/homebrew-core.git
   cd homebrew-core
   ```

2. **Copy formula:**
   ```bash
   cp /path/to/clnrm/homebrew/homebrew-core-formula/clnrm.rb Formula/
   ```

3. **Test thoroughly:**
   ```bash
   brew audit --strict Formula/clnrm.rb
   brew test Formula/clnrm.rb
   brew install --build-from-source Formula/clnrm.rb
   ```

4. **Submit pull request:**
   - Create PR to homebrew-core
   - Include comprehensive description
   - Reference existing tap for testing
   - Respond to maintainer feedback

## Formula Maintenance

### Regular Updates

For each new release:

1. Update version and SHA256 in both formula files
2. Update bottle hashes from automated build
3. Test formula installation
4. Update tap repository
5. Consider homebrew-core update

### Bottle Management

**Bottles are pre-compiled binaries** that avoid compilation time:

- **Advantages:** Fast installation (seconds vs minutes)
- **Platforms:** macOS Intel/ARM, Linux x86_64
- **Fallback:** Source build if no bottle available
- **Updates:** Rebuilt automatically on each release

### Troubleshooting

**Common Issues:**

1. **SHA256 mismatch:**
   - Recalculate source tarball hash
   - Verify bottle hashes from workflow

2. **Build failures:**
   - Check Rust version compatibility
   - Verify all dependencies are available
   - Test locally before release

3. **Audit failures:**
   - Run `brew audit --strict` locally
   - Fix any style or security issues
   - Ensure all tests pass

## Installation Instructions for Users

### Custom Tap Installation

```bash
# Add the tap
brew tap seanchatmangpt/clnrm

# Install the CLI
brew install clnrm

# Verify installation
clnrm --version
```

### Homebrew Core Installation (when available)

```bash
# Install directly (no tap needed)
brew install clnrm

# Verify installation
clnrm --version
```

## Security Considerations

- **Source verification:** All downloads verified with SHA256
- **Bottle integrity:** Bottles signed and verified
- **Dependency management:** Minimal dependencies, statically linked
- **Audit compliance:** Passes Homebrew security audits

## Support

For issues with Homebrew installation:

1. **Check formula status:** https://formulae.brew.sh/formula/clnrm
2. **Report issues:** GitHub repository issues
3. **Community support:** Homebrew community forums

## Release Timeline

**Typical release process:**
- **Day 1:** Create GitHub release, trigger automated build
- **Day 1:** Update formula with hashes, test locally
- **Day 1:** Deploy to custom tap
- **Day 2-7:** Submit to homebrew-core (if desired)
- **Week 2-4:** Homebrew-core review and approval

This process ensures reliable, secure distribution of the Cleanroom CLI through Homebrew's ecosystem.
